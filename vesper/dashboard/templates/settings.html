{% extends "base.html" %}
{% block title %}Vesper — Settings{% endblock %}
{% block body %}
<div class="nav">
    <span class="nav-logo">vesper</span>
    <div class="nav-links">
        <a class="nav-link" href="/dashboard">Dashboard</a>
        <a class="nav-link" href="/dashboard?tab=markets">Markets</a>
        <a class="nav-link" href="/how-it-works">How it works</a>
        <a class="nav-link" href="/trade-history">Trade History</a>
        <a class="nav-link active" href="/settings">Settings</a>
        {% if user.is_admin %}<a class="nav-link" href="/admin">Admin</a>{% endif %}
        <a class="nav-link" href="/logout">Log out</a>
    </div>
</div>

<div class="container" style="max-width:680px;">

    {% if msg == "keys_saved" %}
    <div class="alert alert-success">API keys encrypted and saved.</div>
    {% elif msg == "config_saved" %}
    <div class="alert alert-success">Configuration updated.</div>
    {% elif msg == "mode_changed" %}
    <div class="alert alert-success">Trading mode updated.</div>
    {% elif msg == "password_changed" %}
    <div class="alert alert-success">Password changed successfully.</div>
    {% elif msg == "wrong_password" %}
    <div class="alert alert-error">Current password is incorrect.</div>
    {% elif msg == "password_mismatch" %}
    <div class="alert alert-error">New passwords do not match.</div>
    {% elif msg == "password_weak" %}
    <div class="alert alert-error">Password must include: 8+ characters, uppercase, lowercase, number, and special character.</div>
    {% elif msg == "trades_reset" %}
    <div class="alert alert-success">All trades, positions, and autopilots have been reset. Starting fresh.</div>
    {% endif %}

    <!-- Exchange Connections -->
    <div class="card">
        <div class="card-title">Exchange Connections</div>

        <!-- Coinbase (Crypto) -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:10px;background:{{ 'var(--green-dim)' if has_coinbase else 'rgba(255,255,255,0.04)' }};display:flex;align-items:center;justify-content:center;">
                {% if has_coinbase %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
                {% else %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                {% endif %}
            </div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:600;">Coinbase Advanced <span style="font-size:11px;color:var(--text-muted);font-weight:400;">Crypto</span></div>
                <div style="font-size:12px;color:{{ 'var(--green)' if has_coinbase else 'var(--text-muted)' }};">
                    {{ 'Connected' if has_coinbase else 'Not connected' }}
                </div>
            </div>
            {% if has_coinbase %}
            <form method="POST" action="/settings/api-keys/remove">
                <button type="submit" class="btn btn-sm" style="background:rgba(255,59,48,0.1);color:var(--red);border:1px solid rgba(255,59,48,0.2);font-size:11px;padding:4px 12px;"
                        onclick="return confirm('Disconnect Coinbase?')">Disconnect</button>
            </form>
            {% endif %}
        </div>
        {% if not has_coinbase %}
        <form method="POST" action="/settings/api-keys" style="margin-bottom:20px;padding:12px;border:1px solid var(--border);border-radius:10px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label" for="api_key">API Key</label>
                    <input class="input" type="password" name="api_key" id="api_key" placeholder="Paste your API key" required>
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label" for="api_secret">Private Key</label>
                    <input class="input" type="password" name="api_secret" id="api_secret" placeholder="Paste your private key" required>
                </div>
            </div>
            <button type="submit" class="btn btn-accent btn-sm" style="margin-top:12px;">Connect Coinbase</button>
        </form>
        {% endif %}

        <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

        <!-- Alpaca (Stocks) -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:10px;background:{{ 'var(--green-dim)' if has_alpaca else 'rgba(255,255,255,0.04)' }};display:flex;align-items:center;justify-content:center;">
                {% if has_alpaca %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
                {% else %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                {% endif %}
            </div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:600;">Alpaca <span style="font-size:11px;color:var(--text-muted);font-weight:400;">US Stocks</span></div>
                <div style="font-size:12px;color:{{ 'var(--green)' if has_alpaca else 'var(--text-muted)' }};">
                    {{ 'Connected' if has_alpaca else 'Not connected' }}
                </div>
            </div>
            {% if has_alpaca %}
            <form method="POST" action="/settings/alpaca-keys/remove">
                <button type="submit" class="btn btn-sm" style="background:rgba(255,59,48,0.1);color:var(--red);border:1px solid rgba(255,59,48,0.2);font-size:11px;padding:4px 12px;"
                        onclick="return confirm('Disconnect Alpaca?')">Disconnect</button>
            </form>
            {% endif %}
        </div>
        {% if not has_alpaca %}
        <form method="POST" action="/settings/alpaca-keys" style="padding:12px;border:1px solid var(--border);border-radius:10px;">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">Free paper trading at <a href="https://app.alpaca.markets/signup" target="_blank" style="color:var(--accent);">alpaca.markets</a> — works with paper and live accounts.</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label" for="alpaca_key">API Key</label>
                    <input class="input" type="password" name="alpaca_key" id="alpaca_key" placeholder="PKXXXXXXXXXXXXXXXX" required>
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label" for="alpaca_secret">Secret Key</label>
                    <input class="input" type="password" name="alpaca_secret" id="alpaca_secret" placeholder="Paste your secret key" required>
                </div>
            </div>
            <button type="submit" class="btn btn-accent btn-sm" style="margin-top:12px;">Connect Alpaca</button>
        </form>
        {% endif %}

        <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

        <!-- Kalshi (Predictions) -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:10px;background:{{ 'var(--green-dim)' if has_kalshi else 'rgba(255,255,255,0.04)' }};display:flex;align-items:center;justify-content:center;">
                {% if has_kalshi %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
                {% else %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                {% endif %}
            </div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:600;">Kalshi <span style="font-size:11px;color:var(--text-muted);font-weight:400;">Predictions</span></div>
                <div style="font-size:12px;color:{{ 'var(--green)' if has_kalshi else 'var(--text-muted)' }};">
                    {{ 'Connected' if has_kalshi else 'Not connected' }}
                </div>
            </div>
            {% if has_kalshi %}
            <form method="POST" action="/settings/kalshi-keys/remove">
                <button type="submit" class="btn btn-sm" style="background:rgba(255,59,48,0.1);color:var(--red);border:1px solid rgba(255,59,48,0.2);font-size:11px;padding:4px 12px;"
                        onclick="return confirm('Disconnect Kalshi?')">Disconnect</button>
            </form>
            {% endif %}
        </div>
        {% if not has_kalshi %}
        <form method="POST" action="/settings/kalshi-keys" style="padding:12px;border:1px solid var(--border);border-radius:10px;">
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">CFTC-regulated prediction markets. Powers Coinbase predictions. Get API keys at <a href="https://kalshi.com/sign-up" target="_blank" style="color:var(--accent);">kalshi.com</a></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label" for="kalshi_key">API Key</label>
                    <input class="input" type="password" name="kalshi_key" id="kalshi_key" placeholder="Paste your API key" required>
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label" for="kalshi_secret">Private Key</label>
                    <input class="input" type="password" name="kalshi_secret" id="kalshi_secret" placeholder="Paste your private key" required>
                </div>
            </div>
            <button type="submit" class="btn btn-accent btn-sm" style="margin-top:12px;">Connect Kalshi</button>
        </form>
        {% endif %}

        <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

        <!-- Polymarket (Predictions) -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
            </div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:600;">Polymarket <span style="font-size:11px;color:var(--text-muted);font-weight:400;">Predictions</span></div>
                <div style="font-size:12px;color:var(--text-muted);">
                    Browse-only (wallet connection coming soon)
                </div>
            </div>
        </div>
        <div style="padding:12px;border:1px solid var(--border);border-radius:10px;">
            <div style="font-size:11px;color:var(--text-muted);line-height:1.5;">
                Polymarket prediction markets are available for browsing on the Predictions tab. Wallet connection for placing bets will be added in a future update.
            </div>
        </div>
    </div>

    <!-- AI Research -->
    <div class="card">
        <div class="card-title">AI Research</div>
        <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:40px;height:40px;border-radius:10px;background:var(--green-dim);display:flex;align-items:center;justify-content:center;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
            </div>
            <div style="flex:1;">
                <div style="font-size:14px;font-weight:600;">Deep Research <span style="font-size:11px;color:var(--text-muted);font-weight:400;">Perplexity + Claude</span></div>
                <div style="font-size:12px;color:var(--green);">Active — included with your plan</div>
            </div>
        </div>
        <div style="padding:12px;border:1px solid var(--border);border-radius:10px;margin-top:12px;">
            <div style="font-size:11px;color:var(--text-muted);line-height:1.5;">
                Deep AI research is powered by a two-stage pipeline: <b>Perplexity Sonar</b> searches the web for the latest news, data, and expert analyses, then <b>Claude</b> reasons over the evidence to produce a calibrated probability estimate. Click "Deep Research" on any prediction market card to use it.
            </div>
        </div>
    </div>

    <!-- Trading Config -->
    <div class="card">
        <div class="card-title">Trading</div>
        <form method="POST" action="/settings/trading">
            <input type="hidden" name="symbols" value="{{ user.symbols }}">
            <input type="hidden" name="interval_minutes" value="{{ user.interval_minutes }}">
            <input type="hidden" name="trading_mode" value="{{ user.trading_mode }}">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:end;">
                <div class="input-group">
                    <label class="input-label" for="paper_balance">Paper Balance ($)</label>
                    <input class="input" type="number" name="paper_balance" id="paper_balance"
                           value="{{ user.paper_balance }}" step="1" min="10">
                </div>
                <div class="input-group">
                    <button type="button" class="btn btn-sm" id="btnResetTrades"
                            style="background:rgba(255,59,48,0.1);color:var(--red);border:1px solid rgba(255,59,48,0.2);width:100%;padding:12px 16px;">
                        Reset All Trades
                    </button>
                </div>
            </div>

            <div class="card-title" style="margin-top:8px;">Risk Management</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div class="input-group">
                    <label class="input-label" for="stop_loss_pct">Stop-Loss %</label>
                    <input class="input" type="number" name="stop_loss_pct" id="stop_loss_pct"
                           value="{{ user.stop_loss_pct }}" step="0.1" min="0.5" max="10">
                </div>
                <div class="input-group">
                    <label class="input-label" for="take_profit_min_pct">Take-Profit Min %</label>
                    <input class="input" type="number" name="take_profit_min_pct" id="take_profit_min_pct"
                           value="{{ user.take_profit_min_pct }}" step="0.1" min="0.5" max="20">
                </div>
                <div class="input-group">
                    <label class="input-label" for="take_profit_max_pct">Take-Profit Max %</label>
                    <input class="input" type="number" name="take_profit_max_pct" id="take_profit_max_pct"
                           value="{{ user.take_profit_max_pct }}" step="0.1" min="1" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label" for="max_position_pct">Max Position %</label>
                    <input class="input" type="number" name="max_position_pct" id="max_position_pct"
                           value="{{ user.max_position_pct }}" step="1" min="5" max="100">
                </div>
            </div>
            <button type="submit" class="btn btn-accent btn-sm">Save</button>
        </form>
    </div>

    <!-- Account -->
    <div class="card">
        <div class="card-title">Account</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div>
                <div style="font-size:15px;font-weight:500;">{{ user.email }}</div>
                <div style="font-size:12px;color:var(--green);margin-top:2px;">2FA Active</div>
            </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:20px;">
            <div style="font-size:14px;font-weight:600;margin-bottom:16px;">Change Password</div>
            <form method="POST" action="/settings/change-password">
                <div class="input-group">
                    <label class="input-label" for="current_password">Current Password</label>
                    <input class="input" type="password" name="current_password" id="current_password" required>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="input-group">
                        <label class="input-label" for="new_password">New Password</label>
                        <input class="input" type="password" name="new_password" id="new_password" required minlength="8">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="confirm_password">Confirm New Password</label>
                        <input class="input" type="password" name="confirm_password" id="confirm_password" required minlength="8">
                    </div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;">
                    Must include: 8+ characters, uppercase, lowercase, number, and special character (!@#$%...)
                </div>
                <button type="submit" class="btn btn-accent btn-sm">Change Password</button>
            </form>
        </div>
    </div>
</div>

<!-- Reset Trades Confirmation Modal -->
<div class="modal-overlay" id="resetModal">
    <div class="modal" style="max-width:440px;">
        <button class="modal-close" onclick="document.getElementById('resetModal').classList.remove('active')">&times;</button>
        <div style="text-align:center;margin-bottom:20px;">
            <div style="width:56px;height:56px;border-radius:50%;background:rgba(255,59,48,0.1);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><path d="M12 9v4M12 17h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
            </div>
            <div style="font-size:18px;font-weight:700;margin-bottom:8px;">Reset All Trades?</div>
            <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">
                This will permanently delete:<br>
                <span style="color:var(--red);">All open positions, trade history, autopilot configurations, and P&L data.</span><br><br>
                Your paper balance will be reset to <b>${{ user.paper_balance }}</b>.<br>
                This action <b>cannot be undone</b>.
            </div>
        </div>
        <div style="display:flex;gap:12px;">
            <button class="btn btn-outline" style="flex:1;" onclick="document.getElementById('resetModal').classList.remove('active')">Cancel</button>
            <form method="POST" action="/settings/reset-trades" style="flex:1;">
                <button type="submit" class="btn" style="width:100%;background:var(--red);color:#fff;">Yes, Reset Everything</button>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('btnResetTrades').addEventListener('click', function() {
    document.getElementById('resetModal').classList.add('active');
});
</script>
{% endblock %}
