{% extends "base.html" %}
{% block title %}Vesper{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}
{% block body %}

<div class="nav">
    <span class="nav-logo">vesper</span>
    <div class="nav-links">
        <a class="nav-link active" href="#" onclick="switchTab('trading');return false;" id="navDashboard">Dashboard</a>
        <a class="nav-link" href="#" onclick="switchTab('markets');return false;" id="navMarkets">Markets</a>
        <a class="nav-link" href="/how-it-works">How it works</a>
        <a class="nav-link" href="/trade-history">Trade History</a>
        <a class="nav-link" href="/settings">Settings</a>
        {% if user.is_admin %}<a class="nav-link" href="/admin">Admin</a>{% endif %}
        <div class="nav-trade-mode" id="tradeModeToggle">
            <button class="trade-mode-btn {{ '' if user.trading_mode == 'live' else 'active' }}" id="modePaper" onclick="setTradeMode('paper')" data-mode="paper">
                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#f5a623;margin-right:4px;"></span>Paper
            </button>
            <button class="trade-mode-btn {{ 'active' if user.trading_mode == 'live' else '' }}" id="modeReal" onclick="setTradeMode('real')" data-mode="real">
                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:4px;"></span>Real
            </button>
        </div>
        <a class="nav-link nav-logout" href="/logout" title="Log out">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </a>
    </div>
</div>

<div class="page-wrapper">
<style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* trade-mode-btn styles are in base.html */
    .pm-card {
        background: var(--surface); border: 1px solid var(--border);
        border-radius: 14px; padding: 18px; transition: all 0.2s;
    }
    .pm-card:hover { border-color: var(--border-hover); transform: translateY(-1px); }
    .pm-card.has-edge { border-left: 3px solid var(--green); }
    .pm-prob-bar {
        height: 6px; border-radius: 3px; overflow: hidden;
        background: var(--red-dim); margin-top: 10px;
    }
    .pm-prob-fill {
        height: 100%; border-radius: 3px;
        background: var(--green); transition: width 0.3s;
    }
    .pm-tag {
        display: inline-block; padding: 2px 8px; border-radius: 10px;
        font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.06);
        color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px;
    }
    .pm-volume {
        font-size: 12px; color: var(--text-muted); font-weight: 500;
    }
    .pm-outcome {
        display: flex; justify-content: space-between; align-items: center;
        padding: 6px 0;
    }
    .pm-outcome-name { font-size: 13px; color: var(--text-secondary); }
    .pm-outcome-price { font-size: 14px; font-weight: 700; }
    .pm-edge-badge {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 10px; border-radius: 8px; font-size: 11px; font-weight: 700;
    }
    .pm-edge-badge.positive { background: var(--green-dim); color: var(--green); }
    .pm-edge-badge.neutral { background: rgba(255,255,255,0.05); color: var(--text-muted); }
    .pm-ai-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 12px; margin-top: 12px; border-radius: 10px;
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
    }
    .pm-gain-chip {
        display: inline-block; padding: 2px 8px; border-radius: 6px;
        font-size: 11px; font-weight: 700; background: var(--green-dim); color: var(--green);
    }
    .pm-signals-toggle {
        font-size: 11px; color: var(--accent); cursor: pointer; border: none;
        background: none; padding: 2px 0; font-family: inherit;
    }
    .pm-signals-toggle:hover { text-decoration: underline; }
    .pm-signals-list {
        margin-top: 8px; padding: 10px 12px; border-radius: 8px;
        background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
        display: none;
    }
    .pm-signals-list.open { display: block; }
    .pm-signal-item {
        font-size: 11px; color: var(--text-muted); padding: 3px 0;
        line-height: 1.4;
    }
    .pm-confidence {
        display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px;
    }
    .pm-confidence.high { background: var(--green); }
    .pm-confidence.medium { background: #f5a623; }
    .pm-confidence.low { background: var(--text-muted); }
    .pm-timeframe-pills {
        display: flex; gap: 4px; background: var(--surface); border: 1px solid var(--border);
        border-radius: 8px; padding: 3px;
    }
    .pm-tf-pill {
        padding: 5px 12px; border: none; border-radius: 6px;
        font-size: 11px; font-weight: 600; cursor: pointer;
        background: transparent; color: var(--text-muted);
        font-family: inherit; transition: all 0.2s;
    }
    .pm-tf-pill:hover { color: var(--text); }
    .pm-tf-pill.active { background: var(--card); color: var(--text); }
    .pm-research-btn {
        font-size: 11px; color: var(--accent); cursor: pointer; border: 1px solid rgba(99,102,241,0.2);
        background: rgba(99,102,241,0.08); padding: 3px 10px; border-radius: 6px;
        font-family: inherit; font-weight: 600; transition: all 0.2s;
    }
    .pm-research-btn:hover { background: rgba(99,102,241,0.15); }
    .pm-research-btn.loading { opacity: 0.5; pointer-events: none; }
    .pm-research-panel {
        margin-top: 10px; padding: 14px; border-radius: 10px;
        background: rgba(99,102,241,0.04); border: 1px solid rgba(99,102,241,0.12);
        display: none;
    }
    .pm-research-panel.open { display: block; }
    .pm-research-heading {
        font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 10px;
        display: flex; align-items: center; gap: 6px;
    }
    .pm-research-factors {
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;
    }
    .pm-factor-col { font-size: 11px; line-height: 1.6; }
    .pm-factor-col .label { font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .pm-factor-item { color: var(--text-muted); padding-left: 10px; position: relative; }
    .pm-factor-item::before { content: '•'; position: absolute; left: 0; }
    .pm-factor-item.yes::before { color: var(--green); }
    .pm-factor-item.no::before { color: var(--red); }
    .pm-research-reasoning {
        font-size: 11px; color: var(--text-secondary); line-height: 1.5;
        padding: 8px 10px; border-radius: 6px; background: rgba(255,255,255,0.03);
        margin-bottom: 8px;
    }
    .pm-research-sources {
        font-size: 10px; color: var(--text-muted);
    }

    /* Mobile: position card collapsible details */
    .bet-details-toggle {
        display: none;
        width: 100%; padding: 8px 0; border: none;
        background: rgba(255,255,255,0.03); border-radius: 8px;
        color: var(--accent); font-size: 12px; font-weight: 600;
        cursor: pointer; font-family: inherit; margin-top: 8px;
        transition: all 0.2s;
    }
    .bet-details-toggle:hover { background: rgba(255,255,255,0.06); }
    .bet-details-collapsible { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }

    /* Chart time range pills */
    .chart-range-pills {
        display: flex; gap: 4px; margin-bottom: 8px;
    }
    .chart-range-pill {
        padding: 3px 10px; border: 1px solid var(--glass-border); border-radius: 8px;
        font-size: 10px; font-weight: 600; cursor: pointer;
        background: transparent; color: var(--text-muted);
        font-family: inherit; transition: all 0.2s;
    }
    .chart-range-pill:hover { color: var(--text); }
    .chart-range-pill.active { background: rgba(99,102,241,0.12); color: #818cf8; border-color: rgba(99,102,241,0.3); }

    @media (max-width: 768px) {
        .bet-details-toggle { display: block; }
        .bet-details-collapsible.collapsed { max-height: 0; opacity: 0; overflow: hidden; }
        .bet-details-collapsible.expanded { max-height: 1000px; opacity: 1; }
        .bet-pl-row { font-size: 11px; }
    }
    .pm-research-sources a { color: var(--accent); text-decoration: none; }
    .pm-research-sources a:hover { text-decoration: underline; }
    .pm-research-prob {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 4px 12px; border-radius: 8px; font-size: 13px; font-weight: 700;
        background: rgba(99,102,241,0.12); color: var(--accent);
    }
</style>

<div class="container">

<!-- ═══ TRADING TAB ═══ -->
<div class="tab-content active" id="contentTrading">

    {% if not has_api_keys %}
    <div class="alert" style="background:rgba(255,255,255,0.04);color:var(--text-secondary);border:1px solid var(--border);border-radius:12px;">
        Connect your Coinbase API keys to start trading.
        <a href="/settings" style="margin-left:8px;font-weight:600;">Setup</a>
    </div>
    {% endif %}

    <!-- Portfolio Overview -->
    <div style="margin-bottom:28px;" class="fade-in">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
            <div>
                <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Portfolio Value</div>
                <div style="font-size:42px;font-weight:800;letter-spacing:-2px;line-height:1;background:linear-gradient(135deg, var(--text), var(--text-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;" id="portfolioValue">${{ "{:,.2f}".format(portfolio_value) }}</div>
                <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
                    <span id="totalPnl" class="{{ 'positive' if total_pnl >= 0 else 'negative' }}" style="font-size:15px;font-weight:600;">
                        ${{ "%+.2f"|format(total_pnl) }} ({{ "%+.2f"|format(total_pnl_pct) }}%)
                    </span>
                    <span style="font-size:12px;color:var(--text-muted);">all time</span>
                </div>
            </div>
        </div>

        <!-- Portfolio Value Chart (stacked: uninvested + invested) -->
        <div class="chart-range-pills">
            <button class="chart-range-pill active" data-hours="24" onclick="setChartRange(24)">24h</button>
            <button class="chart-range-pill" data-hours="168" onclick="setChartRange(168)">7d</button>
            <button class="chart-range-pill" data-hours="720" onclick="setChartRange(720)">30d</button>
            <button class="chart-range-pill" data-hours="2160" onclick="setChartRange(2160)">3m</button>
            <button class="chart-range-pill" data-hours="4320" onclick="setChartRange(4320)">6m</button>
        </div>
        <div style="height:180px;margin-bottom:16px;">
            <canvas id="portfolioChart"></canvas>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;">
            <div class="stat-glass" title="Total capital currently deployed in open positions across all autopilots.">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;font-weight:600;">Invested</div>
                <div style="font-size:20px;font-weight:700;" id="statInvested">$0.00</div>
            </div>
            <div class="stat-glass" title="Cumulative profit/loss from all closed trades. This is locked-in gains or losses.">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;font-weight:600;">Realized P&L</div>
                <div style="font-size:20px;font-weight:700;" id="statRealized">${{ "%+.2f"|format(realized_pnl) }}</div>
            </div>
            <div class="stat-glass" title="Current paper profit/loss on open positions. Changes with live prices.">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;font-weight:600;">Unrealized P&L</div>
                <div style="font-size:20px;font-weight:700;" id="statUnrealized">$0.00</div>
            </div>
            <div class="stat-glass" title="Percentage of closed trades that were profitable.">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;font-weight:600;">Win Rate</div>
                <div style="font-size:20px;font-weight:700;display:flex;align-items:baseline;gap:6px;">
                    <span id="statWinRate">{{ "%.0f"|format(win_rate) }}%</span>
                    <span style="font-size:11px;font-weight:500;color:var(--text-muted);"><span id="statTrades">{{ total_trades }}</span> trades</span>
                </div>
            </div>
            <div class="stat-glass" title="Number of currently open positions across all autopilots.">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;font-weight:600;">Open</div>
                <div style="font-size:20px;font-weight:700;" id="statOpen">0</div>
            </div>
        </div>
    </div>

    <!-- ═══ 3 Autopilot Cards ═══ -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(290px,1fr));gap:14px;margin-bottom:24px;">

        <!-- Crypto Autopilot -->
        <div class="card slide-up" id="cryptoCard" style="background:linear-gradient(135deg, rgba(0,232,94,0.04), rgba(0,180,255,0.02));border-color:rgba(0,232,94,0.12);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                <div style="width:38px;height:38px;border-radius:11px;background:rgba(0,232,94,0.1);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:var(--green);box-shadow:0 0 20px rgba(0,232,94,0.1);">&#8383;</div>
                <div style="flex:1;">
                    <div style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;">
                        Crypto
                        <span id="cryptoStatus" style="font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text-muted);font-weight:600;">OFF</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);">60+ coins &middot; Deep Search &middot; Trailing stops</div>
                </div>
            </div>
            <div id="cryptoOff">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <div style="position:relative;flex:1;min-width:80px;">
                        <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:13px;">$</span>
                        <input type="number" id="cryptoAmount" placeholder="200" min="10" step="10"
                               style="padding:8px 8px 8px 22px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(255,255,255,0.03);color:var(--text);width:100%;font-size:13px;box-sizing:border-box;">
                    </div>
                    <button class="btn btn-accent" style="font-size:13px;padding:8px 18px;white-space:nowrap;" onclick="startSegment('crypto')">Start</button>
                </div>
                <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
                    <span style="font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;min-width:28px;">Risk</span>
                    <div class="risk-selector" id="cryptoRisk">
                        <button class="risk-btn" data-risk="conservative" onclick="setRisk('crypto','conservative')">Safe</button>
                        <button class="risk-btn" data-risk="moderate" onclick="setRisk('crypto','moderate')">Mod</button>
                        <button class="risk-btn active" data-risk="aggressive" onclick="setRisk('crypto','aggressive')">Aggro</button>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <span style="font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;min-width:28px;">Re%</span>
                    <input type="range" id="cryptoReinvest" min="0" max="100" value="100" style="flex:1;accent-color:var(--green);">
                    <span id="cryptoReinvestLabel" style="font-size:11px;color:var(--text-secondary);min-width:30px;text-align:right;">100%</span>
                </div>
            </div>
            <div id="cryptoOn" style="display:none;">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;">
                    <div><div style="font-size:17px;font-weight:700;" id="cryptoFund">$0</div><div style="font-size:10px;color:var(--text-muted);">Available</div></div>
                    <div><div style="font-size:17px;font-weight:700;color:var(--accent);" id="cryptoDeployed">$0</div><div style="font-size:10px;color:var(--text-muted);">Deployed</div></div>
                    <div><div style="font-size:17px;font-weight:700;" id="cryptoPositions">0</div><div style="font-size:10px;color:var(--text-muted);">Positions</div></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                    <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:14px;font-weight:700;" id="cryptoUnrealized">$0</div><div style="font-size:10px;color:var(--text-muted);">Unrealized P&L</div>
                    </div>
                    <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:14px;font-weight:700;" id="cryptoRealized">$0</div><div style="font-size:10px;color:var(--text-muted);">Realized P&L</div>
                    </div>
                </div>
                <input type="hidden" id="cryptoMaxBet">
                <div id="cryptoLastScan" style="font-size:11px;color:var(--text-muted);margin-bottom:10px;"></div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-outline btn-sm" onclick="stopSegment('crypto')">Stop</button>
                    <button class="btn btn-sm" style="background:rgba(255,255,255,0.04);color:var(--text-secondary);font-size:11px;" onclick="editSegment('crypto')">Edit</button>
                </div>
            </div>
        </div>

        <!-- Stocks Autopilot -->
        <div class="card slide-up" id="stocksCard" style="background:linear-gradient(135deg, rgba(99,102,241,0.04), rgba(168,85,247,0.03));border-color:rgba(99,102,241,0.12);animation-delay:0.05s;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                <div style="width:38px;height:38px;border-radius:11px;background:rgba(99,102,241,0.1);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#818cf8;box-shadow:0 0 20px rgba(99,102,241,0.08);">&#x1F4C8;</div>
                <div style="flex:1;">
                    <div style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;">
                        Stocks
                        <span id="stocksStatus" style="font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text-muted);font-weight:600;">OFF</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);">AI brain &middot; Deep Search &middot; Whale tracking</div>
                </div>
            </div>
            <div id="stocksOff">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <div style="position:relative;flex:1;min-width:80px;">
                        <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:13px;">$</span>
                        <input type="number" id="stocksAmount" placeholder="500" min="10" step="10"
                               style="padding:8px 8px 8px 22px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(255,255,255,0.03);color:var(--text);width:100%;font-size:13px;box-sizing:border-box;">
                    </div>
                    <button class="btn btn-accent" style="font-size:13px;padding:8px 18px;white-space:nowrap;" onclick="startSegment('stocks')">Start</button>
                </div>
                <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
                    <span style="font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;min-width:28px;">Risk</span>
                    <div class="risk-selector" id="stocksRisk">
                        <button class="risk-btn" data-risk="conservative" onclick="setRisk('stocks','conservative')">Safe</button>
                        <button class="risk-btn" data-risk="moderate" onclick="setRisk('stocks','moderate')">Mod</button>
                        <button class="risk-btn active" data-risk="aggressive" onclick="setRisk('stocks','aggressive')">Aggro</button>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <span style="font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;min-width:28px;">Re%</span>
                    <input type="range" id="stocksReinvest" min="0" max="100" value="100" style="flex:1;accent-color:var(--green);">
                    <span id="stocksReinvestLabel" style="font-size:11px;color:var(--text-secondary);min-width:30px;text-align:right;">100%</span>
                </div>
            </div>
            <div id="stocksOn" style="display:none;">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;">
                    <div><div style="font-size:17px;font-weight:700;" id="stocksFund">$0</div><div style="font-size:10px;color:var(--text-muted);">Available</div></div>
                    <div><div style="font-size:17px;font-weight:700;color:#818cf8;" id="stocksDeployed">$0</div><div style="font-size:10px;color:var(--text-muted);">Deployed</div></div>
                    <div><div style="font-size:17px;font-weight:700;" id="stocksPositions">0</div><div style="font-size:10px;color:var(--text-muted);">Positions</div></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                    <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:14px;font-weight:700;" id="stocksUnrealized">$0</div><div style="font-size:10px;color:var(--text-muted);">Unrealized P&L</div>
                    </div>
                    <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:14px;font-weight:700;" id="stocksRealized">$0</div><div style="font-size:10px;color:var(--text-muted);">Realized P&L</div>
                    </div>
                </div>
                <input type="hidden" id="stocksMaxBet">
                <div id="stocksLastScan" style="font-size:11px;color:var(--text-muted);margin-bottom:10px;"></div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-outline btn-sm" onclick="stopSegment('stocks')">Stop</button>
                    <button class="btn btn-sm" style="background:rgba(255,255,255,0.04);color:var(--text-secondary);font-size:11px;" onclick="editSegment('stocks')">Edit</button>
                </div>
            </div>
        </div>

        <!-- Predictions Autopilot -->
        <div class="card slide-up" id="predictionsCard" style="background:linear-gradient(135deg, rgba(245,166,35,0.04), rgba(234,88,12,0.02));border-color:rgba(245,166,35,0.12);animation-delay:0.1s;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                <div style="width:38px;height:38px;border-radius:11px;background:rgba(245,166,35,0.1);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#f5a623;box-shadow:0 0 20px rgba(245,166,35,0.08);">&#x1F52E;</div>
                <div style="flex:1;">
                    <div style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;">
                        Predictions
                        <span id="predStatus" style="font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text-muted);font-weight:600;">OFF</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);">Perplexity + Claude &middot; Auto-invests on edge</div>
                </div>
            </div>
            <div id="predOff">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <div style="position:relative;flex:1;min-width:80px;">
                        <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:13px;">$</span>
                        <input type="number" id="predAmount" placeholder="100" min="10" step="10"
                               style="padding:8px 8px 8px 22px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(255,255,255,0.03);color:var(--text);width:100%;font-size:13px;box-sizing:border-box;">
                    </div>
                    <button class="btn" style="background:linear-gradient(135deg,#f5a623,#e67700);color:#000;font-weight:700;font-size:13px;padding:8px 18px;white-space:nowrap;" onclick="startSegment('predictions')">Start</button>
                </div>
                <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
                    <span style="font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;min-width:28px;">Risk</span>
                    <div class="risk-selector" id="predRisk">
                        <button class="risk-btn" data-risk="conservative" onclick="setRisk('predictions','conservative')">Safe</button>
                        <button class="risk-btn" data-risk="moderate" onclick="setRisk('predictions','moderate')">Mod</button>
                        <button class="risk-btn active" data-risk="aggressive" onclick="setRisk('predictions','aggressive')">Aggro</button>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <span style="font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;min-width:28px;">Re%</span>
                    <input type="range" id="predReinvest" min="0" max="100" value="100" style="flex:1;accent-color:#f5a623;">
                    <span id="predReinvestLabel" style="font-size:11px;color:var(--text-secondary);min-width:30px;text-align:right;">100%</span>
                </div>
            </div>
            <div id="predOn" style="display:none;">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;">
                    <div><div style="font-size:17px;font-weight:700;" id="predFund">$0</div><div style="font-size:10px;color:var(--text-muted);">Available</div></div>
                    <div><div style="font-size:17px;font-weight:700;color:#f5a623;" id="predDeployed">$0</div><div style="font-size:10px;color:var(--text-muted);">Deployed</div></div>
                    <div><div style="font-size:17px;font-weight:700;" id="predPositions">0</div><div style="font-size:10px;color:var(--text-muted);">Positions</div></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                    <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:14px;font-weight:700;" id="predUnrealized">$0</div><div style="font-size:10px;color:var(--text-muted);">Unrealized P&L</div>
                    </div>
                    <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:14px;font-weight:700;" id="predRealized">$0</div><div style="font-size:10px;color:var(--text-muted);">Realized P&L</div>
                    </div>
                </div>
                <input type="hidden" id="predMaxBet">
                <div id="predLastScan" style="font-size:11px;color:var(--text-muted);margin-bottom:10px;"></div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-outline btn-sm" onclick="stopSegment('predictions')">Stop</button>
                    <button class="btn btn-sm" style="background:rgba(255,255,255,0.04);color:var(--text-secondary);font-size:11px;" onclick="editSegment('predictions')">Edit</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Learn More Modal -->
    <div class="modal-overlay" id="learnMoreModal">
        <div class="modal" style="max-width:640px;">
            <button class="modal-close" onclick="closeLearnMore()">&times;</button>
            <div class="modal-title" id="learnMoreTitle">AI Analysis</div>
            <div id="learnMoreBody" style="font-size:13px;color:var(--text-secondary);line-height:1.7;">Loading...</div>
        </div>
    </div>

    <!-- Edit Segment Modal (unified: fund + max bet + risk + reinvest) -->
    <div class="modal-overlay" id="editSegmentModal">
        <div class="modal" style="max-width:420px;">
            <button class="modal-close" onclick="closeEditSegment()">&times;</button>
            <div class="modal-title" id="editSegmentTitle">Edit Settings</div>
            <div style="display:flex;flex-direction:column;gap:16px;margin-bottom:20px;">
                <div>
                    <label class="input-label">Fund Amount ($)</label>
                    <input type="number" id="editSegFund" class="input" placeholder="500" min="10" step="10">
                </div>
                <div>
                    <label class="input-label">Max Bet per Position ($)</label>
                    <input type="number" id="editSegMaxBet" class="input" placeholder="auto" min="5" step="5">
                    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Leave empty for auto-sizing based on fund and risk level.</div>
                </div>
                <div>
                    <label class="input-label">Risk Level</label>
                    <div class="risk-selector" id="editSegRisk" style="margin-top:4px;">
                        <button class="risk-btn" data-risk="conservative" onclick="document.querySelectorAll('#editSegRisk .risk-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Safe</button>
                        <button class="risk-btn" data-risk="moderate" onclick="document.querySelectorAll('#editSegRisk .risk-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Mod</button>
                        <button class="risk-btn active" data-risk="aggressive" onclick="document.querySelectorAll('#editSegRisk .risk-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Aggro</button>
                    </div>
                </div>
                <div>
                    <label class="input-label">Reinvest Profits (%)</label>
                    <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                        <input type="range" id="editSegReinvest" min="0" max="100" value="100" style="flex:1;accent-color:var(--green);" oninput="document.getElementById('editSegReinvestLabel').textContent=this.value+'%'">
                        <span id="editSegReinvestLabel" style="font-size:12px;color:var(--text-secondary);min-width:36px;text-align:right;">100%</span>
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-accent" style="flex:1;" onclick="submitEditSegment()">Save</button>
                <button class="btn btn-outline" style="flex:1;" onclick="closeEditSegment()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Real Mode Confirmation Modal -->
    <div class="modal-overlay" id="realModeModal">
        <div class="modal" style="max-width:440px;">
            <button class="modal-close" onclick="closeRealMode()">&times;</button>
            <div style="text-align:center;padding:8px 0 20px;">
                <div style="font-size:36px;margin-bottom:12px;">&#x26A0;</div>
                <div class="modal-title" style="margin-bottom:8px;">Switch to Real Mode</div>
                <div style="font-size:13px;color:var(--text-secondary);line-height:1.7;margin-bottom:24px;">
                    You're about to trade with <strong style="color:var(--text);">real money</strong>. All new autopilot sessions and trades will execute actual orders on your connected exchange accounts.<br><br>
                    Make sure your API keys are configured and you understand the risks involved.
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="closeRealMode()">Stay in Paper</button>
                    <button class="btn" style="flex:1;background:linear-gradient(135deg,var(--red),#cc2200);color:#fff;" onclick="confirmRealMode()">I Understand, Go Real</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Close Position Modal -->
    <div class="modal-overlay" id="closePositionModal">
        <div class="modal" style="max-width:420px;">
            <button class="modal-close" onclick="closeCloseModal()">&times;</button>
            <!-- Confirm state -->
            <div id="closeConfirmState">
                <div style="text-align:center;padding:8px 0 0;">
                    <div style="width:56px;height:56px;border-radius:16px;background:rgba(255,59,48,0.1);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:24px;">&#x2716;</div>
                    <div class="modal-title" style="margin-bottom:4px;" id="closeModalSymbol">Close Position</div>
                    <div style="font-size:13px;color:var(--text-muted);margin-bottom:6px;" id="closeModalInfo"></div>
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;" id="closeModalPnlPreview"></div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="closeCloseModal()">Cancel</button>
                    <button class="btn" id="closeConfirmBtn" style="flex:1;background:linear-gradient(135deg,var(--red),#cc2200);color:#fff;" onclick="executeClose()">Close at Market</button>
                </div>
            </div>
            <!-- Loading state -->
            <div id="closeLoadingState" style="display:none;text-align:center;padding:32px 0;">
                <div class="close-spinner"></div>
                <div style="font-size:14px;color:var(--text-secondary);margin-top:16px;font-weight:600;">Closing position...</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Executing at market price</div>
            </div>
            <!-- Result state -->
            <div id="closeResultState" style="display:none;text-align:center;padding:12px 0;">
                <div id="closeResultIcon" style="width:64px;height:64px;border-radius:18px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px;"></div>
                <div class="modal-title" style="margin-bottom:2px;">Position Closed</div>
                <div id="closeResultSymbol" style="font-size:13px;color:var(--text-muted);margin-bottom:20px;"></div>
                <div style="padding:16px;border-radius:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);margin-bottom:20px;">
                    <div id="closeResultPnl" style="font-size:32px;font-weight:800;letter-spacing:-0.5px;"></div>
                    <div id="closeResultPct" style="font-size:15px;margin-top:4px;font-weight:600;"></div>
                    <div style="display:flex;justify-content:center;gap:24px;margin-top:12px;font-size:12px;color:var(--text-muted);">
                        <span id="closeResultEntry"></span>
                        <span id="closeResultExit"></span>
                    </div>
                </div>
                <button class="btn btn-accent" style="width:100%;" onclick="closeCloseModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Active Positions -->
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div class="card-title" style="margin-bottom:0;">Active Positions</div>
            <span style="font-size:12px;color:var(--text-muted);" id="positionCountLabel">0 open</span>
        </div>
        <div id="activeBets">
            <div class="empty-state">
                <div class="empty-state-icon">~</div>
                No active positions — start an autopilot above to begin auto-trading
            </div>
        </div>
    </div>

    <!-- AI Decisions Feed -->
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="card-title" style="margin-bottom:0;">AI Decisions</div>
            <div style="display:flex;gap:8px;align-items:center;">
                <select id="decisionFilter" onchange="fetchDecisions()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-size:12px;">
                    <option value="all">All</option>
                    <option value="actions">Entries & Exits only</option>
                    <option value="skips">Skips only</option>
                </select>
                <span style="font-size:11px;color:var(--text-muted);" id="decisionCount"></span>
            </div>
        </div>
        <div id="decisionsContainer" style="max-height:500px;overflow-y:auto;">
            <div style="color:var(--text-muted);font-style:italic;padding:20px 0;text-align:center;">Loading decisions...</div>
        </div>
    </div>


</div><!-- /contentTrading -->

<!-- ═══ MARKETS TAB ═══ -->
<div class="tab-content" id="contentMarkets">

    <!-- Markets Sub-tabs -->
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap;">
        <div style="display:flex;gap:2px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:3px;" id="marketSubTabs">
            <button class="market-sub-tab active" onclick="switchMarketTab('crypto')" id="mktTabCrypto">
                <span style="font-size:13px;margin-right:4px;">&#8383;</span>Crypto
            </button>
            <button class="market-sub-tab" onclick="switchMarketTab('stocks')" id="mktTabStocks">
                <span style="font-size:13px;margin-right:4px;">&#x1F4C8;</span>Stocks
            </button>
            <button class="market-sub-tab" onclick="switchMarketTab('predictions')" id="mktTabPredictions">
                <span style="font-size:13px;margin-right:4px;">&#x1F52E;</span>Predictions
            </button>
        </div>
        <div id="mktSearchWrap" style="flex:1;min-width:180px;max-width:320px;">
            <input type="text" id="mktSearchInput" placeholder="Search markets..." oninput="filterMarketTable()"
                   style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.03);color:var(--text);font-size:13px;box-sizing:border-box;">
        </div>
    </div>

    <style>
        .market-sub-tab {
            padding: 7px 16px; border: none; border-radius: 8px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            background: transparent; color: var(--text-muted);
            font-family: inherit; transition: all 0.2s;
            display: inline-flex; align-items: center;
        }
        .market-sub-tab:hover { color: var(--text); }
        .market-sub-tab.active { background: var(--card); color: var(--text); }
        .market-sub-content { display: none; }
        .market-sub-content.active { display: block; }
        .mkt-table { width: 100%; border-collapse: collapse; }
        .mkt-table th {
            text-align: left; padding: 10px 12px; font-size: 11px;
            color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
            font-weight: 600; border-bottom: 1px solid var(--border);
            cursor: pointer; user-select: none;
        }
        .mkt-table th:hover { color: var(--text); }
        .mkt-table td {
            padding: 12px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .mkt-table tr:hover { background: rgba(255,255,255,0.02); }
        .mkt-table .mkt-symbol {
            font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px;
        }
        .mkt-table .mkt-symbol-sub { font-size: 11px; color: var(--text-muted); font-weight: 400; }
        .mkt-change { font-weight: 600; font-size: 13px; }
        .mkt-change.up { color: var(--green); }
        .mkt-change.down { color: var(--red); }
    </style>

    <!-- ═══ CRYPTO SUB-TAB ═══ -->
    <div class="market-sub-content active" id="mktContentCrypto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <div>
                <div style="font-size:22px;font-weight:700;letter-spacing:-0.5px;">Crypto Markets</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">60+ altcoins tracked by the AI scanner</div>
            </div>
            <button class="btn btn-sm" style="background:var(--card);border:1px solid var(--border);font-size:12px;" onclick="loadMarketsCrypto()">Refresh</button>
        </div>
        <div id="mktCryptoTable">
            <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading crypto markets...</div>
        </div>
    </div>

    <!-- ═══ STOCKS SUB-TAB ═══ -->
    <div class="market-sub-content" id="mktContentStocks">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <div>
                <div style="font-size:22px;font-weight:700;letter-spacing:-0.5px;">Stock Markets</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Top US equities tracked by the AI autopilot</div>
            </div>
            <button class="btn btn-sm" style="background:var(--card);border:1px solid var(--border);font-size:12px;" onclick="loadMarketsStocks()">Refresh</button>
        </div>
        <div id="mktStocksTable">
            <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading stock markets...</div>
        </div>
    </div>

    <!-- ═══ PREDICTIONS SUB-TAB ═══ -->
    <div class="market-sub-content" id="mktContentPredictions">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap;gap:16px;">
            <div>
                <div style="font-size:22px;font-weight:700;letter-spacing:-0.5px;" id="pmSourceTitle">Polymarket</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Short-term markets with AI edge estimation</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <div class="pm-timeframe-pills">
                    <button class="pm-tf-pill active" onclick="setPmSource('polymarket')" id="pmSrcPoly">Polymarket</button>
                    <button class="pm-tf-pill" onclick="setPmSource('kalshi')" id="pmSrcKalshi">Kalshi</button>
                </div>
                <div class="pm-timeframe-pills">
                    <button class="pm-tf-pill" onclick="setPmTimeframe(3)" id="pmTf3">3d</button>
                    <button class="pm-tf-pill" onclick="setPmTimeframe(7)" id="pmTf7">7d</button>
                    <button class="pm-tf-pill active" onclick="setPmTimeframe(14)" id="pmTf14">14d</button>
                    <button class="pm-tf-pill" onclick="setPmTimeframe(30)" id="pmTf30">30d</button>
                    <button class="pm-tf-pill" onclick="setPmTimeframe(0)" id="pmTf0">All</button>
                </div>
                <select id="pmCategoryFilter" onchange="filterPolymarkets()" style="padding:6px 12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);font-size:12px;">
                    <option value="all">All Categories</option>
                    <option value="Politics">Politics</option>
                    <option value="Sports">Sports</option>
                    <option value="Crypto">Crypto</option>
                    <option value="Business">Business</option>
                    <option value="Science">Science</option>
                    <option value="Pop Culture">Pop Culture</option>
                    <option value="Financials">Financials</option>
                    <option value="World">World</option>
                    <option value="Economics">Economics</option>
                </select>
                <button class="btn btn-sm" style="background:var(--card);border:1px solid var(--border);font-size:12px;" onclick="fetchPolymarkets()">Refresh</button>
            </div>
        </div>

        <div id="pmMethodologyBanner" style="margin-bottom:16px;padding:14px 16px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:14px;">&#x1f9e0;</span>
                    <span style="font-size:13px;font-weight:600;">AI Edge Estimation</span>
                    <span style="font-size:11px;color:var(--text-muted);">Market microstructure analysis</span>
                </div>
                <button class="pm-signals-toggle" onclick="toggleMethodology()">How it works</button>
            </div>
            <div id="pmMethodologyDetail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
                    The AI estimates true probability using <b>5 market microstructure signals</b> — no news, no social media, no insider info. It detects potential mispricings purely from trading patterns:
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                    <div style="padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);">
                        <div style="font-size:11px;font-weight:600;margin-bottom:2px;">1. Volume Momentum</div>
                        <div style="font-size:10px;color:var(--text-muted);">High 24h volume vs total = active repricing. Trends with the money flow direction.</div>
                    </div>
                    <div style="padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);">
                        <div style="font-size:11px;font-weight:600;margin-bottom:2px;">2. Liquidity Depth</div>
                        <div style="font-size:10px;color:var(--text-muted);">Thin order books = wider mispricings. Deep liquidity confirms current price.</div>
                    </div>
                    <div style="padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);">
                        <div style="font-size:11px;font-weight:600;margin-bottom:2px;">3. Spread Analysis</div>
                        <div style="font-size:10px;color:var(--text-muted);">Wide bid-ask spread = market maker uncertainty = opportunity for edge.</div>
                    </div>
                    <div style="padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);">
                        <div style="font-size:11px;font-weight:600;margin-bottom:2px;">4. Contrarian Reversion</div>
                        <div style="font-size:10px;color:var(--text-muted);">Extreme prices (>92% or <8%) tend to overshoot. Statistical mean reversion.</div>
                    </div>
                    <div style="padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);grid-column:span 2;">
                        <div style="font-size:11px;font-weight:600;margin-bottom:2px;">5. Freshness Premium</div>
                        <div style="font-size:10px;color:var(--text-muted);">Low-volume markets have less price discovery = wider potential mispricings. New markets offer better edges.</div>
                    </div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:10px;padding:8px;border-radius:6px;background:rgba(255,165,0,0.05);border:1px solid rgba(255,165,0,0.1);">
                    The AI nudge is typically 2-8% from market price. It's a statistical edge, not a prediction. Think: "the market might be slightly off by this much based on trading patterns." Always do your own research.
                </div>
            </div>
        </div>

        <div id="pmMarketsContainer">
            <div style="text-align:center;padding:40px;color:var(--text-muted);">
                <div style="font-size:20px;margin-bottom:8px;">Loading markets...</div>
            </div>
        </div>
    </div>

</div><!-- /contentMarkets -->

</div>
</div>

<script>
// ═══════════════════════════════════════
// State
// ═══════════════════════════════════════
// Track previous P&L values for flash animations
let prevPnlMap = {};
// Track known position IDs for detecting new cards
let knownPositionIds = new Set();

// ═══════════════════════════════════════
// ═══════════════════════════════════════
// AI Decisions Feed
// ═══════════════════════════════════════
function renderDecision(d) {
    const t = d.time ? new Date(d.time * 1000).toLocaleTimeString('en', {hour:'2-digit', minute:'2-digit', hour12:false}) : '';
    const date = d.time ? new Date(d.time * 1000).toLocaleDateString('en', {month:'short', day:'numeric'}) : '';

    // Action styling
    const actionStyles = {
        'ENTER_LONG':  {icon: '\u25B2', color: 'var(--green)', label: 'ENTERED LONG'},
        'ENTER_SHORT': {icon: '\u25BC', color: 'var(--red)', label: 'ENTERED SHORT'},
        'EXIT':        {icon: '\u25CF', color: '#f80', label: 'EXITED'},
        'SIGNAL_SELL': {icon: '\u25BC', color: '#f80', label: 'SELL SIGNAL'},
        'SKIP':        {icon: '\u2014', color: 'var(--text-muted)', label: 'SKIPPED'},
        'CANDIDATE':   {icon: '\u2605', color: 'var(--accent)', label: 'CANDIDATE'},
        'ERROR':       {icon: '!', color: 'var(--red)', label: 'ERROR'},
    };
    const style = actionStyles[d.action] || actionStyles['SKIP'];
    const conf = d.confidence ? `${(d.confidence * 100).toFixed(0)}%` : '';

    // Source badge
    const sourceBadge = d.source === 'autopilot'
        ? '<span style="background:rgba(99,102,241,0.15);color:#818cf8;padding:1px 6px;border-radius:4px;font-size:10px;margin-left:4px;">autopilot</span>'
        : d.source === 'altcoin_hunter' || d.source === 'altcoin_hunter_rebalance'
        ? '<span style="background:rgba(34,197,94,0.15);color:#22c55e;padding:1px 6px;border-radius:4px;font-size:10px;margin-left:4px;">hunter</span>'
        : d.source === 'ai_exit'
        ? '<span style="background:rgba(255,128,0,0.15);color:#f80;padding:1px 6px;border-radius:4px;font-size:10px;margin-left:4px;">ai exit</span>'
        : '';

    // Trade mode badge
    const modeBadge = d.trade_mode === 'paper'
        ? '<span style="background:rgba(255,255,255,0.06);color:var(--text-muted);padding:1px 6px;border-radius:4px;font-size:10px;">paper</span>'
        : d.trade_mode === 'live' || d.trade_mode === 'real'
        ? '<span style="background:rgba(0,220,90,0.12);color:var(--green);padding:1px 6px;border-radius:4px;font-size:10px;">real</span>'
        : '';

    // Indicators mini-display
    let indicatorsHtml = '';
    if (d.indicators) {
        const ind = d.indicators;
        const parts = [];
        if (ind.rsi) parts.push(`RSI ${ind.rsi}`);
        if (ind.ema_trend) parts.push(`EMA ${ind.ema_trend}`);
        if (ind.adx) parts.push(`ADX ${ind.adx}`);
        if (ind.whale_score && ind.whale_score !== 0) parts.push(`whale ${ind.whale_score > 0 ? '+' : ''}${ind.whale_score}`);
        if (ind.sentiment && ind.sentiment !== 0) parts.push(`sent. ${ind.sentiment > 0 ? '+' : ''}${ind.sentiment}`);
        if (ind.tf_alignment !== null && ind.tf_alignment !== undefined) parts.push(`TF align ${ind.tf_alignment}`);
        if (parts.length > 0) {
            indicatorsHtml = `<div style="margin-top:4px;font-size:10px;color:var(--text-muted);display:flex;gap:8px;flex-wrap:wrap;">${parts.map(p => `<span style="background:rgba(255,255,255,0.03);padding:1px 5px;border-radius:3px;">${p}</span>`).join('')}</div>`;
        }
    }

    // P&L display for exits
    let pnlHtml = '';
    if (d.pnl_pct !== undefined) {
        const pnlCls = d.pnl_pct >= 0 ? 'positive' : 'negative';
        pnlHtml = `<span class="${pnlCls}" style="font-weight:600;margin-left:8px;">${d.pnl_pct >= 0 ? '+' : ''}${d.pnl_pct.toFixed(2)}%</span>`;
    }

    // Amount for entries
    let amountHtml = '';
    if (d.amount_usd) {
        amountHtml = `<span style="color:var(--text-secondary);margin-left:8px;">$${d.amount_usd}</span>`;
    }

    return `<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);${d.action === 'SKIP' ? 'opacity:0.7;' : ''}">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span style="color:${style.color};font-weight:700;font-size:13px;min-width:110px;">${style.icon} ${style.label}</span>
            <span style="font-weight:600;font-size:13px;">${d.symbol || ''}</span>
            ${conf ? `<span style="color:var(--text-secondary);font-size:12px;">${conf} conf</span>` : ''}
            ${pnlHtml}${amountHtml}
            ${sourceBadge}${modeBadge}
            <span style="color:var(--text-muted);font-size:11px;margin-left:auto;">${date} ${t}</span>
        </div>
        <div style="margin-top:3px;font-size:12px;color:var(--text-secondary);padding-left:2px;">${humanizeReason(d.reason || '')}</div>
        ${indicatorsHtml}
    </div>`;
}

async function fetchDecisions() {
    try {
        const resp = await fetch('/api/decisions?limit=50');
        if (!resp.ok) return;
        const data = await resp.json();
        const container = document.getElementById('decisionsContainer');
        const filter = document.getElementById('decisionFilter').value;

        let decisions = data.decisions || [];
        if (filter === 'actions') {
            decisions = decisions.filter(d => ['ENTER_LONG', 'ENTER_SHORT', 'EXIT', 'SIGNAL_SELL'].includes(d.action));
        } else if (filter === 'skips') {
            decisions = decisions.filter(d => d.action === 'SKIP');
        }

        document.getElementById('decisionCount').textContent = `${decisions.length} decisions`;

        if (decisions.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted);font-style:italic;padding:20px 0;text-align:center;">No decisions yet — waiting for next trading cycle...</div>';
            return;
        }

        container.innerHTML = decisions.map(d => renderDecision(d)).join('');
    } catch(e) {
        console.error('Failed to fetch decisions:', e);
    }
}

fetchDecisions();
setInterval(fetchDecisions, 15000);

// ═══════════════════════════════════════
// Active Bets — Full Dynamic Rendering (every 3s)
// ═══════════════════════════════════════
function formatPrice(price) {
    if (price >= 1) return price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    return price.toFixed(4);
}

function formatAiReasoning(p) {
    // Convert raw score/factor dump into clear human language
    const reason = p.strategy_reason || '';
    const name = (p.name || p.symbol.split('/')[0]).replace('PRED:', '');

    // If reason already contains Deep Search results, show them cleanly
    if (reason.includes('Deep Search')) {
        const parts = reason.split('Deep Search');
        const deepPart = parts[1] || '';
        // Extract the AI reasoning portion
        const cleanDeep = deepPart.replace(/^\s*\([^)]*\)\s*:\s*/, '').split('|')[0].trim();
        if (cleanDeep.length > 30) return cleanDeep.substring(0, 250) + (cleanDeep.length > 250 ? '...' : '');
    }

    // For Altcoin Hunter: parse score and factors into a sentence
    const scoreMatch = reason.match(/score\s+([\d.]+)/);
    const score = scoreMatch ? parseFloat(scoreMatch[1]) : 0;
    if (p.strategy_id === 'altcoin_hunter' && score > 0) {
        const strength = score >= 0.7 ? 'very strong' : score >= 0.6 ? 'strong' : score >= 0.5 ? 'moderate' : 'emerging';
        const factors = [];
        if (reason.includes('momentum=1.0') || reason.includes('momentum=0.9')) factors.push('strong upward momentum');
        if (reason.includes('adx_strength=0.8') || reason.includes('adx_strength=0.9') || reason.includes('adx_strength=1.0')) factors.push('strong trend strength');
        if (reason.includes('rsi=0.8') || reason.includes('rsi=0.7')) factors.push('bullish RSI positioning');
        if (reason.includes('volume_surge=0.5') || reason.includes('volume_surge=0.6') || reason.includes('volume_surge=0.7')) factors.push('above-average volume');
        if (reason.includes('ema_alignment=0.75') || reason.includes('ema_alignment=1.0')) factors.push('perfectly aligned moving averages');
        if (reason.includes('btc_relative=0.6') || reason.includes('btc_relative=0.7')) factors.push('outperforming Bitcoin');
        const topFactors = factors.length > 0 ? factors.slice(0, 3).join(', ') : 'multiple technical indicators';
        return `${name} shows a ${strength} uptrend (score ${(score*100).toFixed(0)}/100), driven by ${topFactors}.`;
    }

    // For Predictions: show the AI edge reasoning
    if (p.strategy_id === 'predictions') {
        const edgeMatch = reason.match(/edge\s+([\d.]+)%/);
        return reason.replace(/Predictions AI:\s*/, '').substring(0, 250);
    }

    // For Autopilot: clean up the signal description
    if (p.strategy_id === 'autopilot') {
        return reason.replace(/Smart Auto:\s*/, '').substring(0, 250);
    }

    // Fallback: first 200 chars
    return reason.substring(0, 200) + (reason.length > 200 ? '...' : '');
}

function renderBetCard(p, isNew) {
    const pnlCls = p.pnl_usd >= 0 ? 'positive' : 'negative';
    const pnlSign = p.pnl_usd >= 0 ? '+' : '';
    const pctSign = p.pnl_pct >= 0 ? '+' : '';
    const rr = p.max_loss > 0 ? (p.max_win / p.max_loss) : 0;
    const rrCls = rr >= 2 ? 'positive' : rr >= 1 ? 'neutral' : 'negative';
    const progressPct = Math.max(0, Math.min(100, p.progress));
    const progressColor = p.pnl_usd >= 0 ? 'var(--green)' : 'var(--red)';
    const betMode = p.bet_mode || 'one_off';
    const tradeMode = p.trade_mode || 'paper';
    const modeCls = betMode === 'continuous' ? 'continuous' : 'one_off';
    const hasTrailing = p.trailing_stop_pct > 0;

    // Flash animation class
    let flashClass = '';
    const prevPnl = prevPnlMap[p.id];
    if (prevPnl !== undefined && prevPnl !== p.pnl_usd) {
        flashClass = p.pnl_usd > prevPnl ? 'pnl-flash-positive' : 'pnl-flash-negative';
    }

    const entryDate = p.entry_time ? new Date(p.entry_time * 1000).toLocaleDateString('en', {month:'2-digit', day:'2-digit'}) + ' ' + new Date(p.entry_time * 1000).toLocaleTimeString('en', {hour:'2-digit', minute:'2-digit', hour12:false}) : '';

    // SL/TP row: show trailing info when active
    let slTpRow;
    if (hasTrailing) {
        slTpRow = `<div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;">
            <span style="color:var(--text-muted);" title="Stop-Loss: price at which the position auto-closes to limit losses.">SL $${formatPrice(p.stop_loss)}</span>
            <span style="color:var(--accent);font-weight:600;" title="Trailing Stop: the stop-loss follows the price up by ${p.trailing_stop_pct}%. If price drops ${p.trailing_stop_pct}% from its peak, the position closes — locking in profits while letting winners run.">Trailing ${p.trailing_stop_pct}% &mdash; SL $${formatPrice(p.trailing_sl_price)} (peak $${formatPrice(p.highest_price_seen)})</span>
        </div>`;
    } else {
        slTpRow = `<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-top:4px;">
            <span title="Stop-Loss: the position auto-closes at this price to limit your downside.">SL $${formatPrice(p.stop_loss)}</span>
            <span title="Take-Profit range: the position auto-closes when price reaches this zone to lock in gains.">TP $${formatPrice(p.tp_min)} &ndash; $${formatPrice(p.tp_max)}</span>
        </div>`;
    }

    // Max win display
    const maxWinHtml = hasTrailing
        ? '<span style="font-size:14px;">&#8734;</span> Unlimited'
        : `+$${p.max_win.toFixed(2)}`;

    // Strategy badge
    const stratLabel = p.strategy_id ? p.strategy_id.replace('_', ' ') : '';

    // Asset type icon + symbol display
    const baseSym = p.symbol.split('/')[0];
    const isStock = p.symbol.endsWith('/USD');
    const isPrediction = p.symbol.startsWith('PRED:');
    const companyName = STOCK_NAMES[baseSym] || '';
    const assetIcon = isPrediction
        ? '<span style="font-size:14px;margin-right:4px;" title="Prediction Market">&#x1F3AF;</span>'
        : isStock
        ? '<span style="font-size:14px;margin-right:4px;" title="Stock">&#x1F4C8;</span>'
        : '<span style="font-size:14px;margin-right:4px;" title="Cryptocurrency">&#x20BF;</span>';
    const titleHtml = isPrediction
        ? `${assetIcon}<span style="font-size:14px;font-weight:700;">${(p.name || baseSym).replace('PRED:', '')}</span>`
        : isStock && companyName
        ? `${assetIcon}<span style="font-size:15px;font-weight:800;color:var(--accent);letter-spacing:0.3px;">${baseSym}</span> <span style="font-size:14px;color:var(--text-secondary);font-weight:500;">${companyName}</span>`
        : `${assetIcon}<span style="font-size:16px;font-weight:700;">${p.name || baseSym}</span>`;

    const safeId = p.id.replace(/[^a-zA-Z0-9]/g, '_');
    return `<div class="bet-card ${isNew ? 'new-card' : ''} ${flashClass}" data-pid="${p.id}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
                <div>${titleHtml}</div>
                <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;">
                    <span class="mode-badge mode-${modeCls}">${betMode.replace('_', ' ')}</span>
                    <span class="mode-badge trade-mode-${tradeMode}">${tradeMode}</span>
                    ${hasTrailing ? '<span class="mode-badge" style="background:rgba(0,180,255,0.15);color:#0af;border-color:rgba(0,180,255,0.3);">trailing</span>' : ''}
                    ${stratLabel ? '<span class="mode-badge" style="background:rgba(255,255,255,0.04);color:var(--text-muted);border-color:var(--border);">' + stratLabel + '</span>' : ''}
                </div>
            </div>
            <div style="text-align:right;">
                <div class="bet-pnl ${pnlCls}" title="Unrealized profit/loss on this position. Positive = in profit, negative = at a loss.">$${pnlSign}${p.pnl_usd.toFixed(2)}</div>
                <div style="font-size:12px;color:var(--text-muted);" title="P&L as percentage of position cost.">${pctSign}${p.pnl_pct.toFixed(2)}%</div>
            </div>
        </div>
        <!-- Current Price (live) -->
        <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
            <span class="bet-current-price" title="Live market price, updated every few seconds."><span class="live-dot"></span> Now $${formatPrice(p.current_price)}</span>
            <span style="font-size:12px;color:var(--text-muted);" title="How far the current price has moved from your entry price.">${p.current_price >= p.entry_price ? '\u25B2' : '\u25BC'} ${Math.abs(p.pnl_pct).toFixed(2)}% from entry</span>
        </div>
        <!-- See More toggle (mobile only) -->
        <button class="bet-details-toggle" onclick="toggleBetDetails(this)">See details &#x25BC;</button>
        <!-- Collapsible details section -->
        <div class="bet-details-collapsible collapsed">
        <!-- P/L Evolution Chart -->
        <div style="margin-top:10px;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px;">P&L Evolution</div>
                <div style="font-size:10px;color:var(--text-muted);" id="sparktime-${safeId}"></div>
            </div>
            <div style="height:52px;position:relative;">
                <canvas id="spark-${safeId}" style="width:100%;height:52px;"></canvas>
            </div>
        </div>
        <!-- P/L View -->
        <div class="bet-pl-row">
            <div class="bet-pl-item">
                <span class="bet-pl-label" title="Maximum possible loss if stop-loss triggers.">Max Loss &#9432;</span>
                <span class="bet-pl-value" style="color:var(--red);">-$${p.max_loss.toFixed(2)}</span>
            </div>
            <div class="bet-pl-item">
                <span class="bet-pl-label" title="Estimated exchange trading fee.">Fee &#9432;</span>
                <span class="bet-pl-value" style="color:var(--text-muted);">~$${(p.est_fee || 0).toFixed(2)}</span>
            </div>
            <div class="bet-pl-item">
                <span class="bet-pl-label" title="Maximum profit if take-profit triggers.">Max Win &#9432;</span>
                <span class="bet-pl-value" style="color:var(--green);">${maxWinHtml}</span>
            </div>
            <div class="bet-pl-item">
                <span class="bet-pl-label" title="Risk-to-Reward ratio.">R:R &#9432;</span>
                <span class="bet-pl-value bet-rr ${rrCls}">${hasTrailing ? '&#8734;' : '1:' + rr.toFixed(1)}</span>
            </div>
        </div>
        <div style="display:flex;gap:16px;margin-top:8px;font-size:13px;color:var(--text-secondary);flex-wrap:wrap;">
            <span title="The price at which this position was opened.">Entry $${formatPrice(p.entry_price)}</span>
            <span title="Total USD invested in this position.">Size $${p.cost_usd.toFixed(2)}</span>
            <span style="color:var(--text-muted);" title="Date and time the position was opened.">${entryDate}</span>
        </div>
        <div class="bet-progress" title="Progress between stop-loss (0%) and take-profit (100%).">
            <div class="bet-progress-fill" style="width:${progressPct}%;background:${progressColor};"></div>
        </div>
        ${slTpRow}
        <!-- AI Entry Reason -->
        ${p.strategy_reason ? `<div style="margin-top:10px;padding:10px 12px;background:rgba(0,232,94,0.03);border:1px solid rgba(0,232,94,0.08);border-radius:10px;font-size:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span style="font-weight:600;color:var(--accent);font-size:11px;text-transform:uppercase;letter-spacing:0.3px;">AI Reasoning</span>
                <button style="background:none;border:none;color:var(--accent);font-size:11px;cursor:pointer;font-weight:600;font-family:inherit;padding:2px 6px;" onclick="openLearnMore('${p.id}','${p.name || p.symbol}')">Learn More &rarr;</button>
            </div>
            <div style="color:var(--text-secondary);line-height:1.5;">${formatAiReasoning(p)}</div>
        </div>` : ''}
        </div><!-- end collapsible -->
        <button class="btn btn-outline btn-sm" style="width:100%;margin-top:12px;"
                onclick="closeTrade('${p.id}','${p.symbol}',${p.pnl_usd},${p.pnl_pct})">Close Position</button>
    </div>`;
}

async function updatePositions() {
    try {
        const resp = await fetch('/api/positions?mode=' + currentTradeMode);
        if (!resp.ok) return;
        const positions = await resp.json();
        const container = document.getElementById('activeBets');

        // Update position count label
        const countLabel = document.getElementById('positionCountLabel');
        if (countLabel) countLabel.textContent = positions.length + ' open';

        if (positions.length === 0) {
            container.innerHTML = `<div class="empty-state">
                <div class="empty-state-icon">~</div>
                No active positions — start an autopilot above to begin auto-trading
            </div>`;
            knownPositionIds.clear();
            prevPnlMap = {};
            return;
        }

        // Build new position ID set
        const newIds = new Set(positions.map(p => p.id));

        // Render all cards
        let html = '<div class="bet-grid">';
        positions.forEach(p => {
            const isNew = !knownPositionIds.has(p.id);
            html += renderBetCard(p, isNew);
        });
        html += '</div>';
        container.innerHTML = html;

        // Update tracking state
        positions.forEach(p => { prevPnlMap[p.id] = p.pnl_usd; });
        // Clean up removed positions from prevPnlMap
        Object.keys(prevPnlMap).forEach(id => {
            if (!newIds.has(id)) delete prevPnlMap[id];
        });
        knownPositionIds = newIds;

        // Render P/L charts for each position
        positions.forEach(p => {
            const safeId = p.id.replace(/[^a-zA-Z0-9]/g, '_');
            const canvas = document.getElementById('spark-' + safeId);
            const timeEl = document.getElementById('sparktime-' + safeId);
            if (canvas && p.price_history && p.price_history.length > 1) {
                drawPnlChart(canvas, p.price_history, p.entry_price, p.amount, p.side || 'buy', timeEl);
            }
        });
    } catch(e) {}
}

function smartTimeLabel(seconds) {
    if (seconds < 60) return Math.floor(seconds) + 's';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
    return Math.floor(seconds / 86400) + 'd';
}

function drawPnlChart(canvas, history, entryPrice, amount, side, timeEl) {
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    const w = rect.width;
    const h = rect.height;
    ctx.clearRect(0, 0, w, h);

    if (!history || history.length < 2) return;

    // Calculate P/L values from price history
    const pnlData = history.map(s => {
        const price = s.p || 0;
        const pnl = side === 'buy' ? (price - entryPrice) * amount : (entryPrice - price) * amount;
        return { t: s.t, pnl: pnl };
    });

    const pnlValues = pnlData.map(d => d.pnl);
    const minPnl = Math.min(0, ...pnlValues);
    const maxPnl = Math.max(0, ...pnlValues);
    const pnlRange = (maxPnl - minPnl) || 1;
    const padding = pnlRange * 0.15;
    const rangeMin = minPnl - padding;
    const rangeMax = maxPnl + padding;
    const totalRange = rangeMax - rangeMin;

    // Draw zero line
    const zeroY = h - ((0 - rangeMin) / totalRange) * h;
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 3]);
    ctx.beginPath();
    ctx.moveTo(0, zeroY);
    ctx.lineTo(w, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Draw P/L line
    const lastPnl = pnlValues[pnlValues.length - 1];
    const lineColor = lastPnl >= 0 ? '#00e85e' : '#ff4444';
    const fillColor = lastPnl >= 0 ? 'rgba(0,232,94,0.1)' : 'rgba(255,68,68,0.1)';

    ctx.beginPath();
    const stepX = w / (pnlValues.length - 1);
    pnlValues.forEach((v, i) => {
        const x = i * stepX;
        const y = h - ((v - rangeMin) / totalRange) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.strokeStyle = lineColor;
    ctx.lineWidth = 1.5;
    ctx.lineJoin = 'round';
    ctx.stroke();

    // Fill under line to zero
    ctx.lineTo(w, zeroY);
    ctx.lineTo(0, zeroY);
    ctx.closePath();
    ctx.fillStyle = fillColor;
    ctx.fill();

    // End dot
    const endX = (pnlValues.length - 1) * stepX;
    const endY = h - ((lastPnl - rangeMin) / totalRange) * h;
    ctx.beginPath();
    ctx.arc(endX, endY, 3, 0, Math.PI * 2);
    ctx.fillStyle = lineColor;
    ctx.fill();

    // Smart timeline label
    if (timeEl && pnlData.length >= 2) {
        const elapsed = pnlData[pnlData.length - 1].t - pnlData[0].t;
        timeEl.textContent = smartTimeLabel(elapsed) + ' ago';
    }
}
function toggleBetDetails(btn) {
    const collapsible = btn.nextElementSibling;
    if (collapsible.classList.contains('collapsed')) {
        collapsible.classList.remove('collapsed');
        collapsible.classList.add('expanded');
        btn.innerHTML = 'Hide details &#x25B2;';
        // Redraw sparklines after expanding (canvas needs visible parent)
        setTimeout(() => {
            const card = btn.closest('.bet-card');
            if (card) {
                const canvas = card.querySelector('canvas');
                if (canvas) canvas.dispatchEvent(new Event('resize'));
            }
        }, 100);
    } else {
        collapsible.classList.remove('expanded');
        collapsible.classList.add('collapsed');
        btn.innerHTML = 'See details &#x25BC;';
    }
}
// Initial fetch, then WebSocket takes over (with polling fallback)
updatePositions();

// ═══════════════════════════════════════
// Close Position Modal
// ═══════════════════════════════════════

// Stock company name mapping
const STOCK_NAMES = {
    'AAPL': 'Apple', 'MSFT': 'Microsoft', 'GOOGL': 'Alphabet',
    'AMZN': 'Amazon', 'NVDA': 'Nvidia', 'META': 'Meta',
    'TSLA': 'Tesla', 'AMD': 'AMD', 'NFLX': 'Netflix',
    'CRM': 'Salesforce', 'AVGO': 'Broadcom', 'ORCL': 'Oracle',
    'PLTR': 'Palantir', 'COIN': 'Coinbase', 'SQ': 'Block',
    'SHOP': 'Shopify', 'UBER': 'Uber', 'ABNB': 'Airbnb',
    'SNOW': 'Snowflake', 'MSTR': 'MicroStrategy',
};

let _closePosId = null;

function getSymbolDisplay(symbol) {
    const base = symbol.split('/')[0];
    const name = STOCK_NAMES[base];
    if (name) return `${base} · ${name}`;
    return base;
}

function closeTrade(positionId, symbol, pnlUsd, pnlPct) {
    _closePosId = positionId;
    const modal = document.getElementById('closePositionModal');
    const symDisplay = getSymbolDisplay(symbol || '');
    document.getElementById('closeModalSymbol').textContent = `Close ${symDisplay}`;
    document.getElementById('closeModalInfo').textContent = 'This will close your position at current market price.';

    // Show current P&L preview
    const previewEl = document.getElementById('closeModalPnlPreview');
    if (pnlUsd !== undefined) {
        const sign = pnlUsd >= 0 ? '+' : '';
        const color = pnlUsd >= 0 ? 'var(--green)' : 'var(--red)';
        previewEl.innerHTML = `Current P&L: <span style="color:${color};font-weight:700;">${sign}$${pnlUsd.toFixed(2)} (${sign}${pnlPct.toFixed(2)}%)</span>`;
    } else {
        previewEl.textContent = '';
    }

    // Reset to confirm state
    document.getElementById('closeConfirmState').style.display = 'block';
    document.getElementById('closeLoadingState').style.display = 'none';
    document.getElementById('closeResultState').style.display = 'none';
    modal.classList.add('active');
}

function closeCloseModal() {
    document.getElementById('closePositionModal').classList.remove('active');
    _closePosId = null;
}

async function executeClose() {
    if (!_closePosId) return;

    // Switch to loading state
    document.getElementById('closeConfirmState').style.display = 'none';
    document.getElementById('closeLoadingState').style.display = 'block';

    try {
        const resp = await fetch('/api/close-trade', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ position_id: _closePosId }),
        });
        const data = await resp.json();

        if (data.ok) {
            // Switch to result state
            document.getElementById('closeLoadingState').style.display = 'none';
            document.getElementById('closeResultState').style.display = 'block';

            const isProfit = data.pnl_usd >= 0;
            const sign = isProfit ? '+' : '';
            const color = isProfit ? 'var(--green)' : 'var(--red)';

            // Icon
            const iconEl = document.getElementById('closeResultIcon');
            iconEl.style.background = isProfit ? 'rgba(0,232,94,0.1)' : 'rgba(255,59,48,0.1)';
            iconEl.style.color = color;
            iconEl.innerHTML = isProfit ? '&#x2714;' : '&#x2716;';

            // Symbol
            document.getElementById('closeResultSymbol').textContent = getSymbolDisplay(data.symbol || '');

            // P&L
            document.getElementById('closeResultPnl').style.color = color;
            document.getElementById('closeResultPnl').textContent = `${sign}$${data.pnl_usd.toFixed(2)}`;
            document.getElementById('closeResultPct').style.color = color;
            document.getElementById('closeResultPct').textContent = `${sign}${data.pnl_pct.toFixed(2)}%`;

            // Entry/Exit
            document.getElementById('closeResultEntry').textContent = `Entry $${formatPrice(data.entry_price)}`;
            document.getElementById('closeResultExit').textContent = `Exit $${formatPrice(data.exit_price)}`;

            // Refresh data in background
            updatePositions();
            updatePortfolioStats();
        } else {
            document.getElementById('closeLoadingState').style.display = 'none';
            document.getElementById('closeConfirmState').style.display = 'block';
            document.getElementById('closeModalInfo').innerHTML = `<span style="color:var(--red);">${data.error || 'Failed to close position'}</span>`;
        }
    } catch(e) {
        document.getElementById('closeLoadingState').style.display = 'none';
        document.getElementById('closeConfirmState').style.display = 'block';
        document.getElementById('closeModalInfo').innerHTML = '<span style="color:var(--red);">Network error — please try again</span>';
    }
}

// ═══════════════════════════════════════
// AI Reasoning for Open Positions
// ═══════════════════════════════════════
// ═══════════════════════════════════════
// Live Portfolio Stats + P&L Chart (every 5s)
// ═══════════════════════════════════════
// Portfolio Chart (stacked: uninvested + invested)
let _portfolioChartInstance = null;
const _portfolioChartHistory = [];

function renderTopPortfolioChart() {
    const ctx = document.getElementById('portfolioChart');
    if (!ctx) return;
    // Use all data (API already downsamples to ~500 points max)
    const data = _portfolioChartHistory.slice(-500);
    if (data.length < 1) return;

    // Smart labels: use date format for ranges > 24h, time-only for shorter
    const spanHours = data.length > 1 ? (data[data.length-1].time - data[0].time) / 3600 : 0;
    const labels = data.map(d => {
        if (!d.time) return '';
        const dt = new Date(d.time * 1000);
        if (spanHours > 48) return dt.toLocaleDateString('en', {month:'short', day:'numeric'});
        if (spanHours > 24) return dt.toLocaleDateString('en', {month:'short', day:'numeric'}) + ' ' + dt.toLocaleTimeString('en', {hour:'2-digit', minute:'2-digit', hour12:false});
        return dt.toLocaleTimeString('en', {hour:'2-digit', minute:'2-digit', hour12:false});
    });
    const totalData = data.map(d => d.value || 0);
    const investedData = data.map(d => d.invested || 0);
    const uninvestedData = data.map(d => (d.value || 0) - (d.invested || 0));

    if (_portfolioChartInstance) _portfolioChartInstance.destroy();

    // Create gradient fills
    const chartCtx = ctx.getContext('2d');
    const gradTotal = chartCtx.createLinearGradient(0, 0, 0, ctx.parentElement.clientHeight);
    gradTotal.addColorStop(0, 'rgba(99,102,241,0.20)');
    gradTotal.addColorStop(1, 'rgba(99,102,241,0.01)');
    const gradInvested = chartCtx.createLinearGradient(0, 0, 0, ctx.parentElement.clientHeight);
    gradInvested.addColorStop(0, 'rgba(139,92,246,0.18)');
    gradInvested.addColorStop(1, 'rgba(139,92,246,0.01)');
    const gradUninvested = chartCtx.createLinearGradient(0, 0, 0, ctx.parentElement.clientHeight);
    gradUninvested.addColorStop(0, 'rgba(0,232,94,0.12)');
    gradUninvested.addColorStop(1, 'rgba(0,232,94,0.01)');

    _portfolioChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Total Value',
                    data: totalData,
                    borderColor: '#818cf8',
                    backgroundColor: gradTotal,
                    borderWidth: 2.5,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHoverBackgroundColor: '#818cf8',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2,
                    tension: 0.35,
                    order: 0,
                },
                {
                    label: 'Invested',
                    data: investedData,
                    borderColor: 'rgba(139,92,246,0.6)',
                    backgroundColor: gradInvested,
                    borderWidth: 1.5,
                    borderDash: [4, 3],
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    tension: 0.35,
                    order: 1,
                },
                {
                    label: 'Cash',
                    data: uninvestedData,
                    borderColor: 'rgba(0,232,94,0.5)',
                    backgroundColor: gradUninvested,
                    borderWidth: 1.5,
                    borderDash: [4, 3],
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    tension: 0.35,
                    order: 2,
                },
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true, position: 'top', align: 'end',
                    labels: {
                        color: '#6b7280', boxWidth: 8, boxHeight: 8,
                        font: { size: 11, weight: '500' }, padding: 12,
                        usePointStyle: true, pointStyle: 'circle',
                    }
                },
                tooltip: {
                    mode: 'index', intersect: false,
                    backgroundColor: 'rgba(15,15,15,0.95)',
                    borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1,
                    titleColor: '#9ca3af', titleFont: { size: 11 },
                    bodyColor: '#e5e7eb', bodyFont: { size: 12, weight: '600' },
                    padding: 12, cornerRadius: 10,
                    displayColors: true,
                    boxWidth: 8, boxHeight: 8, boxPadding: 4,
                    callbacks: {
                        title: items => items[0]?.label || '',
                        label: c => ' ' + c.dataset.label + ':  $' + c.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: { color: '#3f3f46', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 6 },
                    grid: { display: false },
                    border: { display: false },
                },
                y: {
                    display: true, position: 'right',
                    ticks: {
                        color: '#3f3f46', font: { size: 10 }, maxTicksLimit: 4,
                        callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(1) + 'k' : v.toFixed(0)),
                    },
                    grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                    border: { display: false },
                }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
    });
}

async function updatePortfolioStats() {
    try {
        const resp = await fetch('/api/portfolio-stats?mode=' + currentTradeMode);
        if (!resp.ok) return;
        const s = await resp.json();

        // Portfolio value (cash + positions + unrealized P&L)
        document.getElementById('portfolioValue').textContent = '$' + s.portfolio_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Total P&L
        const pnlEl = document.getElementById('totalPnl');
        const sign = s.total_pnl >= 0 ? '+' : '';
        pnlEl.textContent = '$' + sign + s.total_pnl.toFixed(2) + ' (' + sign + s.total_pnl_pct.toFixed(2) + '%)';
        pnlEl.className = s.total_pnl >= 0 ? 'positive' : 'negative';

        // Stats grid
        document.getElementById('statWinRate').textContent = Math.round(s.win_rate) + '%';
        document.getElementById('statTrades').textContent = s.total_trades;
        document.getElementById('statOpen').textContent = s.open_count;

        // Invested
        const investedEl = document.getElementById('statInvested');
        investedEl.textContent = '$' + s.total_invested.toFixed(2);

        // Realized P&L
        const rSign = s.realized_pnl >= 0 ? '+' : '';
        const realizedEl = document.getElementById('statRealized');
        realizedEl.textContent = '$' + rSign + s.realized_pnl.toFixed(2);
        realizedEl.style.color = s.realized_pnl >= 0 ? 'var(--green)' : s.realized_pnl < 0 ? 'var(--red)' : '';

        // Unrealized P&L
        const uSign = s.unrealized_pnl >= 0 ? '+' : '';
        const unrealizedEl = document.getElementById('statUnrealized');
        unrealizedEl.textContent = '$' + uSign + s.unrealized_pnl.toFixed(2);
        unrealizedEl.style.color = s.unrealized_pnl >= 0 ? 'var(--green)' : s.unrealized_pnl < 0 ? 'var(--red)' : '';

        // Portfolio chart: append data point
        const now = Math.floor(Date.now() / 1000);
        const lastPt = _portfolioChartHistory[_portfolioChartHistory.length - 1];
        if (!lastPt || now - lastPt.time > 5) {
            _portfolioChartHistory.push({ time: now, value: s.portfolio_value, invested: s.total_invested });
            renderTopPortfolioChart();
        }
    } catch(e) {}
}

// Portfolio chart time range (in hours)
let _chartRangeHours = 24;

// Load historical portfolio snapshots from the backend
async function loadPortfolioHistory(hours) {
    try {
        const resp = await fetch('/api/portfolio-history?hours=' + hours);
        if (!resp.ok) return;
        const data = await resp.json();
        const snapshots = data.snapshots || [];
        if (snapshots.length > 0) {
            // Replace current history with server-side snapshots
            _portfolioChartHistory.length = 0;
            snapshots.forEach(s => {
                _portfolioChartHistory.push({ time: s.t, value: s.v, invested: s.i || 0 });
            });
            renderTopPortfolioChart();
            return;
        }
    } catch(e) {
        console.log('Portfolio history not available yet:', e);
    }
    // Fallback: seed with current value if no history
    _portfolioChartHistory.push({ time: Math.floor(Date.now() / 1000) - 30, value: {{ portfolio_value }}, invested: 0 });
    renderTopPortfolioChart();
}

function setChartRange(hours) {
    _chartRangeHours = hours;
    document.querySelectorAll('.chart-range-pill').forEach(b => {
        b.classList.toggle('active', parseInt(b.getAttribute('data-hours')) === hours);
    });
    loadPortfolioHistory(hours);
}

// Initial load: 24h
loadPortfolioHistory(24);

// Also fetch live stats (will append new data points)
updatePortfolioStats();

// ═══════════════════════════════════════
// WebSocket: real-time updates (replaces polling)
// Falls back to polling if WS unavailable
// ═══════════════════════════════════════
let _ws = null;
let _wsRetries = 0;
let _wsFallbackTimer = null;

function getSessionCookie() {
    const match = document.cookie.match(/(?:^|; )session=([^;]*)/);
    return match ? match[1] : '';
}

function applyWsPositions(positions) {
    // Filter by current trade mode (strict — no fallback to avoid mode leaking)
    let filtered = positions.filter(p => (p.trade_mode || 'paper') === currentTradeMode);
    const container = document.getElementById('activeBets');
    const countLabel = document.getElementById('positionCountLabel');
    if (countLabel) countLabel.textContent = filtered.length + ' open';

    if (filtered.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">~</div>No active positions — start an autopilot above to begin auto-trading</div>`;
        knownPositionIds.clear();
        prevPnlMap = {};
        return;
    }

    const newIds = new Set(filtered.map(p => p.id));
    let html = '<div class="bet-grid">';
    filtered.forEach(p => {
        const isNew = !knownPositionIds.has(p.id);
        html += renderBetCard(p, isNew);
    });
    html += '</div>';
    container.innerHTML = html;

    filtered.forEach(p => { prevPnlMap[p.id] = p.pnl_usd; });
    Object.keys(prevPnlMap).forEach(id => { if (!newIds.has(id)) delete prevPnlMap[id]; });
    knownPositionIds = newIds;

    // P/L charts
    filtered.forEach(p => {
        const safeId = p.id.replace(/[^a-zA-Z0-9]/g, '_');
        const canvas = document.getElementById('spark-' + safeId);
        const timeEl = document.getElementById('sparktime-' + safeId);
        if (canvas && p.price_history && p.price_history.length > 1) {
            drawPnlChart(canvas, p.price_history, p.entry_price, p.amount, p.side || 'buy', timeEl);
        }
    });
}

let _lastWsStats = null;

function applyWsStats(allStats) {
    _lastWsStats = allStats;
    // Pick stats for current trade mode (WS sends { paper: {...}, real: {...} })
    const s = allStats[currentTradeMode] || allStats['paper'] || allStats;
    if (!s || !s.portfolio_value) return;

    document.getElementById('portfolioValue').textContent = '$' + s.portfolio_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const pnlEl = document.getElementById('totalPnl');
    const sign = s.total_pnl >= 0 ? '+' : '';
    pnlEl.textContent = '$' + sign + s.total_pnl.toFixed(2) + ' (' + sign + s.total_pnl_pct.toFixed(2) + '%)';
    pnlEl.className = s.total_pnl >= 0 ? 'positive' : 'negative';
    document.getElementById('statWinRate').textContent = Math.round(s.win_rate) + '%';
    document.getElementById('statTrades').textContent = s.total_trades;
    document.getElementById('statOpen').textContent = s.open_count;
    document.getElementById('statInvested').textContent = '$' + s.total_invested.toFixed(2);
    const rSign = s.realized_pnl >= 0 ? '+' : '';
    const realizedEl = document.getElementById('statRealized');
    realizedEl.textContent = '$' + rSign + s.realized_pnl.toFixed(2);
    realizedEl.style.color = s.realized_pnl >= 0 ? 'var(--green)' : s.realized_pnl < 0 ? 'var(--red)' : '';
    const uSign = s.unrealized_pnl >= 0 ? '+' : '';
    const unrealizedEl = document.getElementById('statUnrealized');
    unrealizedEl.textContent = '$' + uSign + s.unrealized_pnl.toFixed(2);
    unrealizedEl.style.color = s.unrealized_pnl >= 0 ? 'var(--green)' : s.unrealized_pnl < 0 ? 'var(--red)' : '';
    // Portfolio chart: append data point
    const now = Math.floor(Date.now() / 1000);
    const lastPt = _portfolioChartHistory[_portfolioChartHistory.length - 1];
    if (!lastPt || now - lastPt.time > 5) {
        _portfolioChartHistory.push({ time: now, value: s.portfolio_value, invested: s.total_invested });
        renderTopPortfolioChart();
    }
}

function startWs() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    _ws = new WebSocket(proto + '//' + location.host + '/ws/live');

    _ws.onopen = () => {
        _wsRetries = 0;
        _ws.send(JSON.stringify({ type: 'auth', session: getSessionCookie() }));
        // Stop polling fallback
        if (_wsFallbackTimer) { clearInterval(_wsFallbackTimer); _wsFallbackTimer = null; }
    };

    _ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            if (msg.type === 'update') {
                applyWsPositions(msg.positions || []);
                if (msg.stats) applyWsStats(msg.stats);
                if (msg.segments) applyWsSegments(msg.segments);
            }
        } catch(err) {}
    };

    _ws.onclose = () => {
        _ws = null;
        _wsRetries++;
        // Exponential backoff: 2s, 4s, 8s, max 30s
        const delay = Math.min(2000 * Math.pow(2, _wsRetries - 1), 30000);
        setTimeout(startWs, delay);
        // Start polling fallback while WS is down
        if (!_wsFallbackTimer) {
            _wsFallbackTimer = setInterval(() => { updatePositions(); updatePortfolioStats(); }, 5000);
        }
    };

    _ws.onerror = () => { _ws.close(); };
}

// Launch WebSocket
startWs();

// Guaranteed 10s refresh cycle (positions + stats) as safety net
// WS provides faster updates when connected, but this ensures the dashboard
// never goes stale even if WS drops silently
setInterval(() => {
    updatePositions();
    updatePortfolioStats();
}, 10000);

// ═══════════════════════════════════════
// Unified Autopilot Segments (Crypto / Stocks / Predictions)
// ═══════════════════════════════════════

// Segment config: maps UI segment name → API endpoint + element IDs
let currentTradeMode = '{{ "real" if user.trading_mode == "live" else "paper" }}';

const SEGMENTS = {
    crypto: {
        api: '/api/altcoin-hunter',
        statusEl: 'cryptoStatus', offEl: 'cryptoOff', onEl: 'cryptoOn',
        fundEl: 'cryptoFund', deployedEl: 'cryptoDeployed', posEl: 'cryptoPositions',
        unrealizedEl: 'cryptoUnrealized', realizedEl: 'cryptoRealized', maxBetEl: 'cryptoMaxBet',
        scanEl: 'cryptoLastScan', topEl: null, amountEl: 'cryptoAmount',
        riskEl: 'cryptoRisk', reinvestEl: 'cryptoReinvest', reinvestLabelEl: 'cryptoReinvestLabel',
        activeLabel: 'ACTIVE', activeColor: 'var(--green)',
        extraBody: {max_positions: 20, trailing_stop_pct: 2.0},
    },
    stocks: {
        api: '/api/autopilot',
        statusEl: 'stocksStatus', offEl: 'stocksOff', onEl: 'stocksOn',
        fundEl: 'stocksFund', deployedEl: 'stocksDeployed', posEl: 'stocksPositions',
        unrealizedEl: 'stocksUnrealized', realizedEl: 'stocksRealized', maxBetEl: 'stocksMaxBet',
        scanEl: 'stocksLastScan', topEl: null, amountEl: 'stocksAmount',
        riskEl: 'stocksRisk', reinvestEl: 'stocksReinvest', reinvestLabelEl: 'stocksReinvestLabel',
        activeLabel: 'ACTIVE', activeColor: '#818cf8',
        extraBody: {max_positions: 20},
    },
    predictions: {
        api: '/api/predictions-autopilot',
        statusEl: 'predStatus', offEl: 'predOff', onEl: 'predOn',
        fundEl: 'predFund', deployedEl: 'predDeployed', posEl: 'predPositions',
        unrealizedEl: 'predUnrealized', realizedEl: 'predRealized', maxBetEl: 'predMaxBet',
        scanEl: 'predLastScan', topEl: null, amountEl: 'predAmount',
        riskEl: 'predRisk', reinvestEl: 'predReinvest', reinvestLabelEl: 'predReinvestLabel',
        activeLabel: 'SCANNING', activeColor: '#f5a623',
        extraBody: {max_positions: 20},
    },
};

function renderScanInfo(log, segment) {
    if (!log || log.length === 0) return 'Waiting for first scan...';
    const e = log[log.length - 1];
    const t = e.time ? new Date(e.time * 1000).toLocaleTimeString('en', {hour:'2-digit', minute:'2-digit', hour12:false}) : '';
    const scanned = e.symbols_scanned || e.markets_scanned || 0;
    const actions = e.actions || [];
    const buys = actions.filter(a => a.action === 'BUY').length;

    if (e.status === 'starting') return `Started ${t} — first scan in progress...`;
    if (e.status === 'no_markets') return `Scan ${t} — markets unavailable, retrying next cycle`;
    if (e.status === 'error') return `Scan ${t} — ${e.error || 'error occurred'}`;
    if (e.status === 'fully_deployed') return `Scan ${t} — all slots filled`;
    if (e.status === 'low_funds') return `Scan ${t} — low funds`;
    if (e.status === 'invested') return `Scan ${t} — ${buys} new position(s)`;
    if (buys > 0) return `Scan ${t} — ${buys} position(s) opened`;
    if (e.status === 'no_edge') return `Scan ${t} — ${e.researched || 0} researched, no edge found`;
    return `Scan ${t} — ${scanned} scanned, no opportunity`;
}

async function fetchSegmentStatus(segment) {
    const cfg = SEGMENTS[segment];
    if (!cfg) return;
    try {
        const resp = await fetch(cfg.api + '?mode=' + currentTradeMode);
        if (!resp.ok) return;
        const data = await resp.json();

        const statusEl = document.getElementById(cfg.statusEl);
        const onEl = document.getElementById(cfg.onEl);
        const offEl = document.getElementById(cfg.offEl);

        if (data.enabled) {
            statusEl.textContent = cfg.activeLabel;
            statusEl.style.background = cfg.activeColor;
            statusEl.style.color = '#000';
            onEl.style.display = 'block';
            offEl.style.display = 'none';
            document.getElementById(cfg.fundEl).textContent = '$' + (data.available_usd || 0).toFixed(0);
            document.getElementById(cfg.deployedEl).textContent = '$' + (data.deployed_usd || 0).toFixed(0);
            document.getElementById(cfg.posEl).textContent =
                (data.positions || []).length;

            // Unrealized + Realized P&L
            if (cfg.unrealizedEl) {
                const ue = document.getElementById(cfg.unrealizedEl);
                const uv = data.unrealized_pnl || 0;
                const us = uv >= 0 ? '+' : '';
                ue.textContent = us + '$' + uv.toFixed(2);
                ue.style.color = uv >= 0 ? 'var(--green)' : 'var(--red)';
            }
            if (cfg.realizedEl) {
                const re = document.getElementById(cfg.realizedEl);
                const rv = data.realized_pnl || 0;
                const rs = rv >= 0 ? '+' : '';
                re.textContent = rs + '$' + rv.toFixed(2);
                re.style.color = rv >= 0 ? 'var(--green)' : 'var(--red)';
            }

            // Max bet
            if (cfg.maxBetEl && data.max_bet_usd) {
                document.getElementById(cfg.maxBetEl).value = data.max_bet_usd;
            }

            // Sync risk level from server
            if (data.risk_level && cfg.riskEl) {
                setRisk(segment, data.risk_level);
            }

            // Sync reinvest pct from server
            if (data.reinvest_pct !== undefined && cfg.reinvestEl) {
                const slider = document.getElementById(cfg.reinvestEl);
                const label = document.getElementById(cfg.reinvestLabelEl);
                if (slider) slider.value = data.reinvest_pct;
                if (label) label.textContent = data.reinvest_pct + '%';
            }

            // Scan info
            const scanEl = document.getElementById(cfg.scanEl);
            if (scanEl && data.log) {
                scanEl.textContent = renderScanInfo(data.log, segment);
            }

            // Top scores (crypto only)
            if (cfg.topEl && data.log && data.log.length > 0) {
                const topEl = document.getElementById(cfg.topEl);
                const lastLog = data.log[data.log.length - 1];
                const scores = lastLog.top_scores || [];
                if (topEl && scores.length > 0) {
                    topEl.innerHTML = scores.slice(0, 5).map(s =>
                        `<span style="display:inline-block;padding:2px 6px;margin:1px;border-radius:5px;font-size:10px;font-weight:600;` +
                        `background:${s.score >= 0.65 ? 'var(--green-dim)' : 'rgba(255,255,255,0.05)'};` +
                        `color:${s.score >= 0.65 ? 'var(--green)' : 'var(--text-muted)'};">` +
                        `${s.symbol.replace('/USDT','')} ${(s.score*100).toFixed(0)}%</span>`
                    ).join('');
                }
            }
        } else {
            statusEl.textContent = 'OFF';
            statusEl.style.background = 'var(--border)';
            statusEl.style.color = 'var(--text-muted)';
            onEl.style.display = 'none';
            offEl.style.display = 'block';
        }
    } catch(e) {}
}

function applyWsSegments(segments) {
    for (const [segment, data] of Object.entries(segments)) {
        const cfg = SEGMENTS[segment];
        if (!cfg || !data) continue;
        try {
            const statusEl = document.getElementById(cfg.statusEl);
            const onEl = document.getElementById(cfg.onEl);
            const offEl = document.getElementById(cfg.offEl);
            if (!statusEl || !onEl || !offEl) continue;

            if (data.enabled) {
                statusEl.textContent = cfg.activeLabel;
                statusEl.style.background = cfg.activeColor;
                statusEl.style.color = '#000';
                onEl.style.display = 'block';
                offEl.style.display = 'none';

                document.getElementById(cfg.fundEl).textContent = '$' + (data.available_usd || 0).toFixed(0);
                document.getElementById(cfg.deployedEl).textContent = '$' + (data.deployed_usd || 0).toFixed(0);
                document.getElementById(cfg.posEl).textContent = data.positions_count || 0;

                if (cfg.unrealizedEl) {
                    const ue = document.getElementById(cfg.unrealizedEl);
                    const uv = data.unrealized_pnl || 0;
                    ue.textContent = (uv >= 0 ? '+' : '') + '$' + uv.toFixed(2);
                    ue.style.color = uv >= 0 ? 'var(--green)' : 'var(--red)';
                }
                if (cfg.realizedEl) {
                    const re = document.getElementById(cfg.realizedEl);
                    const rv = data.realized_pnl || 0;
                    re.textContent = (rv >= 0 ? '+' : '') + '$' + rv.toFixed(2);
                    re.style.color = rv >= 0 ? 'var(--green)' : 'var(--red)';
                }

                if (cfg.maxBetEl && data.max_bet_usd) {
                    document.getElementById(cfg.maxBetEl).value = data.max_bet_usd;
                }

                if (data.risk_level && cfg.riskEl) {
                    setRisk(segment, data.risk_level);
                }

                if (data.reinvest_pct !== undefined && cfg.reinvestEl) {
                    const slider = document.getElementById(cfg.reinvestEl);
                    const label = document.getElementById(cfg.reinvestLabelEl);
                    if (slider) slider.value = data.reinvest_pct;
                    if (label) label.textContent = data.reinvest_pct + '%';
                }

                const scanEl = document.getElementById(cfg.scanEl);
                if (scanEl && data.log) {
                    scanEl.textContent = renderScanInfo(data.log, segment);
                }

                if (cfg.topEl && data.log && data.log.length > 0) {
                    const topEl = document.getElementById(cfg.topEl);
                    const lastLog = data.log[data.log.length - 1];
                    const scores = lastLog.top_scores || [];
                    if (topEl && scores.length > 0) {
                        topEl.innerHTML = scores.slice(0, 5).map(s =>
                            `<span style="display:inline-block;padding:2px 6px;margin:1px;border-radius:5px;font-size:10px;font-weight:600;` +
                            `background:${s.score >= 0.65 ? 'var(--green-dim)' : 'rgba(255,255,255,0.05)'};` +
                            `color:${s.score >= 0.65 ? 'var(--green)' : 'var(--text-muted)'};">` +
                            `${s.symbol.replace('/USDT','')} ${(s.score*100).toFixed(0)}%</span>`
                        ).join('');
                    }
                }
            } else {
                statusEl.textContent = 'OFF';
                statusEl.style.background = 'var(--border)';
                statusEl.style.color = 'var(--text-muted)';
                onEl.style.display = 'none';
                offEl.style.display = 'block';
            }
        } catch(e) {}
    }
}

function getSelectedRisk(segment) {
    const cfg = SEGMENTS[segment];
    if (!cfg || !cfg.riskEl) return 'aggressive';
    const riskEl = document.getElementById(cfg.riskEl);
    if (!riskEl) return 'aggressive';
    const active = riskEl.querySelector('.risk-btn.active');
    return active ? active.getAttribute('data-risk') : 'aggressive';
}

function getReinvestPct(segment) {
    const cfg = SEGMENTS[segment];
    if (!cfg || !cfg.reinvestEl) return 100;
    const slider = document.getElementById(cfg.reinvestEl);
    return slider ? parseInt(slider.value) : 100;
}

async function startSegment(segment) {
    const cfg = SEGMENTS[segment];
    if (!cfg) return;
    const inputEl = document.getElementById(cfg.amountEl);
    const rawVal = inputEl.value || inputEl.placeholder || '0';
    const amount = parseFloat(rawVal);
    if (!amount || amount < 10) {
        alert('Minimum $10');
        return;
    }
    try {
        const body = {
            action: 'start',
            amount_usd: amount,
            risk_level: getSelectedRisk(segment),
            reinvest_pct: getReinvestPct(segment),
            trade_mode: currentTradeMode,
            ...cfg.extraBody,
        };
        const resp = await fetch(cfg.api, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body),
        });
        if (resp.ok) fetchSegmentStatus(segment);
    } catch(e) {}
}

async function stopSegment(segment) {
    const cfg = SEGMENTS[segment];
    if (!cfg) return;
    const label = segment.charAt(0).toUpperCase() + segment.slice(1);
    if (!confirm(`Stop ${label} autopilot? Existing positions will be managed on next cycle.`)) return;
    try {
        const resp = await fetch(cfg.api, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'stop'}),
        });
        if (resp.ok) fetchSegmentStatus(segment);
    } catch(e) {}
}

// Fetch all segments on load, refresh every 10s
['crypto', 'stocks', 'predictions'].forEach(s => fetchSegmentStatus(s));
setInterval(() => {
    ['crypto', 'stocks', 'predictions'].forEach(s => fetchSegmentStatus(s));
}, 10000);

// ═══════════════════════════════════════
// Risk Level Selector
// ═══════════════════════════════════════
function setRisk(segment, level) {
    const cfg = SEGMENTS[segment];
    if (!cfg || !cfg.riskEl) return;
    const container = document.getElementById(cfg.riskEl);
    container.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('active'));
    const btn = container.querySelector(`[data-risk="${level}"]`);
    if (btn) btn.classList.add('active');
}

// ═══════════════════════════════════════
// Edit Segment (unified: fund + max bet + risk + reinvest)
// ═══════════════════════════════════════
let editingSegment = null;
function editSegment(segment) {
    editingSegment = segment;
    const cfg = SEGMENTS[segment];
    const label = segment.charAt(0).toUpperCase() + segment.slice(1);
    document.getElementById('editSegmentTitle').textContent = `Edit ${label} Settings`;

    // Pre-fill current values
    const fundEl = document.getElementById(cfg.fundEl);
    const fundVal = fundEl ? parseFloat(fundEl.textContent.replace(/[$,]/g, '')) : 0;
    document.getElementById('editSegFund').value = fundVal > 0 ? Math.round(fundVal) : '';

    const maxBetEl = document.getElementById(cfg.maxBetEl);
    document.getElementById('editSegMaxBet').value = maxBetEl && maxBetEl.value ? maxBetEl.value : '';

    // Sync risk level
    const currentRisk = getSelectedRisk(segment);
    document.querySelectorAll('#editSegRisk .risk-btn').forEach(b => {
        b.classList.toggle('active', b.getAttribute('data-risk') === currentRisk);
    });

    // Sync reinvest pct
    const reinvestPct = getReinvestPct(segment);
    document.getElementById('editSegReinvest').value = reinvestPct;
    document.getElementById('editSegReinvestLabel').textContent = reinvestPct + '%';

    document.getElementById('editSegmentModal').classList.add('active');
    setTimeout(() => document.getElementById('editSegFund').focus(), 100);
}
function closeEditSegment() {
    document.getElementById('editSegmentModal').classList.remove('active');
    editingSegment = null;
}
document.getElementById('editSegmentModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditSegment();
});
async function submitEditSegment() {
    if (!editingSegment) return;
    const cfg = SEGMENTS[editingSegment];
    const fundVal = parseFloat(document.getElementById('editSegFund').value);
    const maxBetVal = parseFloat(document.getElementById('editSegMaxBet').value);
    const riskBtn = document.querySelector('#editSegRisk .risk-btn.active');
    const riskLevel = riskBtn ? riskBtn.getAttribute('data-risk') : 'aggressive';
    const reinvestPct = parseInt(document.getElementById('editSegReinvest').value);

    const body = { action: 'update' };
    if (fundVal && fundVal >= 10) body.amount_usd = fundVal;
    if (maxBetVal && maxBetVal >= 5) body.max_bet_usd = maxBetVal;
    body.risk_level = riskLevel;
    body.reinvest_pct = reinvestPct;

    try {
        const resp = await fetch(cfg.api, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body),
        });
        if (resp.ok) {
            // Sync risk + reinvest on the main card too
            setRisk(editingSegment, riskLevel);
            const slider = document.getElementById(cfg.reinvestEl);
            const label = document.getElementById(cfg.reinvestLabelEl);
            if (slider) slider.value = reinvestPct;
            if (label) label.textContent = reinvestPct + '%';
            fetchSegmentStatus(editingSegment);
        }
    } catch(e) {}
    closeEditSegment();
}

// ═══════════════════════════════════════
// Learn More Modal — Full AI Analysis
// ═══════════════════════════════════════
async function openLearnMore(pid, name) {
    const modal = document.getElementById('learnMoreModal');
    const title = document.getElementById('learnMoreTitle');
    const body = document.getElementById('learnMoreBody');
    title.textContent = `AI Analysis — ${name}`;
    body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Loading full analysis...</div>';
    modal.classList.add('active');
    try {
        const resp = await fetch(`/api/position-analysis/${encodeURIComponent(pid)}`);
        if (!resp.ok) {
            body.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">No detailed analysis available for this position.</div>';
            return;
        }
        const data = await resp.json();
        let html = '';

        // Header: Signal badge + Confidence + Entry info
        const signalColor = data.signal === 'BUY' ? 'var(--green)' : data.signal === 'SELL' ? 'var(--red)' : 'var(--text-secondary)';
        const confPct = data.confidence ? (data.confidence * 100).toFixed(0) : null;
        html += `<div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
            <span style="padding:4px 14px;border-radius:8px;font-weight:800;font-size:14px;background:${data.signal === 'BUY' ? 'var(--green-dim)' : data.signal === 'SELL' ? 'var(--red-dim)' : 'rgba(255,255,255,0.05)'};color:${signalColor};">${data.signal || 'N/A'}</span>`;
        if (confPct) html += `<span style="font-size:13px;color:var(--text-secondary);">Confidence: <b>${confPct}%</b></span>`;
        if (data.trend_score) html += `<span style="font-size:13px;color:var(--text-secondary);">Trend Score: <b>${(data.trend_score * 100).toFixed(0)}/100</b></span>`;
        if (data.entry_price) html += `<span style="font-size:12px;color:var(--text-muted);">Entry: $${formatPrice(data.entry_price)}</span>`;
        if (data.cost_usd) html += `<span style="font-size:12px;color:var(--text-muted);">Size: $${data.cost_usd.toFixed(2)}</span>`;
        html += `</div>`;

        // Trend Factors (Altcoin Hunter specific)
        if (data.trend_factors && typeof data.trend_factors === 'object') {
            const tf = data.trend_factors;
            const factorItems = [];
            if (tf.momentum !== undefined) factorItems.push({name: 'Momentum', val: tf.momentum, desc: 'Price momentum over recent candles'});
            if (tf.rsi !== undefined) factorItems.push({name: 'RSI Score', val: tf.rsi, desc: 'Relative Strength Index positioning'});
            if (tf.ema_alignment !== undefined) factorItems.push({name: 'EMA Alignment', val: tf.ema_alignment, desc: 'Moving average crossover strength'});
            if (tf.volume_surge !== undefined) factorItems.push({name: 'Volume Surge', val: tf.volume_surge, desc: 'Volume above 20-period average'});
            if (tf.adx_strength !== undefined) factorItems.push({name: 'ADX Strength', val: tf.adx_strength, desc: 'Trend directional strength'});
            if (tf.btc_relative !== undefined) factorItems.push({name: 'BTC Relative', val: tf.btc_relative, desc: 'Performance vs Bitcoin'});
            if (factorItems.length) {
                html += `<div style="margin-bottom:16px;">
                    <div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Trend Analysis Breakdown</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">`;
                factorItems.forEach(f => {
                    const pct = (f.val * 100).toFixed(0);
                    const barColor = f.val >= 0.7 ? 'var(--green)' : f.val >= 0.4 ? '#f5a623' : 'var(--red)';
                    html += `<div style="padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-size:11px;font-weight:600;color:var(--text-secondary);">${f.name}</span>
                            <span style="font-size:11px;font-weight:700;color:${barColor};">${pct}%</span>
                        </div>
                        <div style="height:4px;border-radius:2px;background:rgba(255,255,255,0.06);overflow:hidden;">
                            <div style="height:100%;width:${pct}%;background:${barColor};border-radius:2px;"></div>
                        </div>
                        <div style="font-size:9px;color:var(--text-muted);margin-top:3px;">${f.desc}</div>
                    </div>`;
                });
                html += `</div></div>`;
            }
        }

        // Prediction Market Meta (AI probability vs Market)
        if (data.prediction_meta) {
            const pm = data.prediction_meta;
            const edgeColor = pm.edge >= 10 ? 'var(--green)' : pm.edge >= 5 ? '#f5a623' : 'var(--text-secondary)';
            html += `<div style="margin-bottom:16px;">
                <div style="font-size:11px;font-weight:700;color:#a855f7;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:14px;">&#x1F3AF;</span> Prediction Market Analysis
                </div>
                <div style="padding:12px;border-radius:10px;background:rgba(168,85,247,0.04);border:1px solid rgba(168,85,247,0.1);">
                    ${pm.question ? `<div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:10px;line-height:1.5;">${escapeHtml(pm.question)}</div>` : ''}
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                        <div style="text-align:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);">
                            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">AI Probability</div>
                            <div style="font-size:18px;font-weight:800;color:var(--accent);">${pm.ai_prob || 0}%</div>
                        </div>
                        <div style="text-align:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);">
                            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">Market Price</div>
                            <div style="font-size:18px;font-weight:800;color:var(--text-secondary);">${pm.mkt_prob || 0}%</div>
                        </div>
                        <div style="text-align:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);">
                            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">Edge</div>
                            <div style="font-size:18px;font-weight:800;color:${edgeColor};">${pm.edge || 0}%</div>
                        </div>
                    </div>
                    ${pm.side ? `<div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Position: <span style="font-weight:700;color:${pm.side === 'yes' ? 'var(--green)' : 'var(--red)'};">${pm.side.toUpperCase()}</span>${pm.source ? ` on ${escapeHtml(pm.source)}` : ''}</div>` : ''}
                </div>
            </div>`;
        }

        // Social Sentiment (X/Twitter)
        if (data.social_sentiment && data.social_sentiment.summary) {
            const ss = data.social_sentiment;
            const sentColor = ss.sentiment === 'bullish' ? 'var(--green)' : ss.sentiment === 'bearish' ? 'var(--red)' : '#f5a623';
            const volLabel = ss.volume === 'high' ? 'High volume' : ss.volume === 'low' ? 'Low volume' : 'Normal volume';
            html += `<div style="margin-bottom:16px;">
                <div style="font-size:11px;font-weight:700;color:#1d9bf0;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:14px;">&#x1D54F;</span> X / Twitter Sentiment
                </div>
                <div style="padding:12px;border-radius:10px;background:rgba(29,155,240,0.04);border:1px solid rgba(29,155,240,0.12);">
                    <div style="display:flex;gap:12px;margin-bottom:8px;">
                        <span style="padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;background:${sentColor}22;color:${sentColor};">${ss.sentiment || 'unknown'}</span>
                        <span style="font-size:11px;color:var(--text-muted);">${volLabel}</span>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">${escapeHtml(ss.summary)}</div>
                </div>
            </div>`;
        }

        // Deep Search Summary
        if (data.search_summary) {
            html += `<div style="margin-bottom:16px;">
                <div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:14px;">&#x1F50D;</span> Deep Search (Perplexity + Claude)
                </div>
                <div style="padding:12px;border-radius:10px;background:rgba(0,232,94,0.03);border:1px solid rgba(0,232,94,0.08);font-size:12px;color:var(--text-secondary);line-height:1.6;">${escapeHtml(data.search_summary)}</div>
            </div>`;
        }

        // AI Reasoning
        if (data.reasoning) {
            html += `<div style="margin-bottom:16px;">
                <div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:14px;">&#x1F9E0;</span> AI Reasoning
                </div>
                <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-line;">${escapeHtml(data.reasoning)}</div>
            </div>`;
        }

        // Bullish / Bearish Factors
        if ((data.bullish_factors && data.bullish_factors.length) || (data.bearish_factors && data.bearish_factors.length)) {
            html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
            if (data.bullish_factors && data.bullish_factors.length) {
                html += `<div style="padding:10px;border-radius:10px;background:rgba(0,232,94,0.03);border:1px solid rgba(0,232,94,0.08);">
                    <div style="font-size:11px;font-weight:700;color:var(--green);margin-bottom:8px;">Bullish Factors</div>`;
                data.bullish_factors.forEach(f => {
                    html += `<div style="font-size:11px;color:var(--text-secondary);padding:3px 0 3px 14px;position:relative;line-height:1.5;"><span style="position:absolute;left:0;color:var(--green);font-weight:bold;">+</span>${escapeHtml(f)}</div>`;
                });
                html += `</div>`;
            }
            if (data.bearish_factors && data.bearish_factors.length) {
                html += `<div style="padding:10px;border-radius:10px;background:rgba(255,59,48,0.03);border:1px solid rgba(255,59,48,0.08);">
                    <div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:8px;">Bearish Factors</div>`;
                data.bearish_factors.forEach(f => {
                    html += `<div style="font-size:11px;color:var(--text-secondary);padding:3px 0 3px 14px;position:relative;line-height:1.5;"><span style="position:absolute;left:0;color:var(--red);font-weight:bold;">-</span>${escapeHtml(f)}</div>`;
                });
                html += `</div>`;
            }
            html += `</div>`;
        }

        // Catalysts
        if (data.catalysts && data.catalysts.length) {
            html += `<div style="margin-bottom:16px;">
                <div style="font-size:11px;font-weight:700;color:#f5a623;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Upcoming Catalysts</div>`;
            data.catalysts.forEach(c => {
                html += `<div style="font-size:11px;color:var(--text-secondary);padding:3px 0;line-height:1.5;">&#x26A1; ${escapeHtml(c)}</div>`;
            });
            html += `</div>`;
        }

        // Technical Indicators
        if (data.indicators) {
            const ind = data.indicators;
            const parts = [];
            if (ind.price) parts.push(['Price', '$' + formatPrice(ind.price)]);
            if (ind.rsi) parts.push(['RSI', ind.rsi]);
            if (ind.ema_trend) parts.push(['EMA Trend', ind.ema_trend]);
            if (ind.adx) parts.push(['ADX', ind.adx]);
            if (ind.atr) parts.push(['ATR', '$' + ind.atr]);
            if (ind.bb_position !== undefined && ind.bb_position !== null) parts.push(['Bollinger Pos', typeof ind.bb_position === 'number' ? (ind.bb_position > 1 ? ind.bb_position.toFixed(0) : (ind.bb_position * 100).toFixed(0)) + '%' : ind.bb_position]);
            if (ind.macd_hist !== undefined) parts.push(['MACD Hist', ind.macd_hist]);
            if (ind.whale_score !== undefined) parts.push(['Whale Activity', ind.whale_score]);
            if (ind.sentiment !== undefined) parts.push(['Sentiment', ind.sentiment]);
            if (ind.fear_greed !== undefined && ind.fear_greed !== null) parts.push(['Fear & Greed', ind.fear_greed]);
            if (ind.tf_alignment) parts.push(['TF Alignment', ind.tf_alignment]);
            if (parts.length > 0) {
                html += `<div style="margin-bottom:16px;">
                    <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Technical Indicators at Entry</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">`;
                parts.forEach(([label, val]) => {
                    html += `<span style="padding:5px 12px;border-radius:8px;font-size:11px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);"><b style="color:var(--text-secondary);">${label}</b> <span style="color:var(--text);">${val}</span></span>`;
                });
                html += `</div></div>`;
            }
        }

        // Risk Level
        if (data.risk_level) {
            const riskColor = data.risk_level === 'conservative' ? 'var(--green)' : data.risk_level === 'moderate' ? '#f5a623' : 'var(--red)';
            html += `<div style="margin-bottom:16px;font-size:12px;color:var(--text-muted);">Risk profile: <span style="color:${riskColor};font-weight:600;text-transform:capitalize;">${data.risk_level}</span></div>`;
        }

        // Sources
        if (data.sources && data.sources.length) {
            html += `<div><div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Research Sources</div>`;
            html += `<div style="font-size:11px;color:var(--text-muted);line-height:1.8;">`;
            data.sources.forEach(s => {
                if (s.startsWith('http')) {
                    html += `<div><a href="${escapeHtml(s)}" target="_blank" style="color:var(--accent);text-decoration:none;">${escapeHtml(s)}</a></div>`;
                } else {
                    html += `<div>${escapeHtml(s)}</div>`;
                }
            });
            html += `</div></div>`;
        }

        // If we have no meaningful content, show the raw reasoning as a fallback
        if (!html && data.reasoning) {
            const cleanReason = data.reasoning.replace(/\|/g, '\n').replace(/\[/g, '\n[').trim();
            html = `<div style="margin-bottom:16px;">
                <div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
                    <span style="font-size:14px;">&#x1F9E0;</span> Strategy Analysis
                </div>
                <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-line;">${escapeHtml(cleanReason)}</div>
            </div>`;
        }
        body.innerHTML = html || '<div style="color:var(--text-muted);text-align:center;padding:20px;">No detailed analysis data stored for this position. New positions opened after this update will include full AI analysis.</div>';
    } catch(e) {
        body.innerHTML = '<div style="color:var(--red);text-align:center;padding:20px;">Failed to load analysis.</div>';
    }
}

function closeLearnMore() {
    document.getElementById('learnMoreModal').classList.remove('active');
}
// Close modal on overlay click
document.getElementById('learnMoreModal').addEventListener('click', function(e) {
    if (e.target === this) closeLearnMore();
});

// ═══════════════════════════════════════
// Paper / Real Trade Mode
// ═══════════════════════════════════════
function showModeBanner(msg) {
    // Show a non-blocking banner that auto-dismisses
    let banner = document.getElementById('modeBanner');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'modeBanner';
        banner.style.cssText = 'position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:200;padding:10px 24px;border-radius:12px;font-size:13px;font-weight:600;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);transition:opacity 0.3s;pointer-events:none;';
        document.body.appendChild(banner);
    }
    banner.textContent = msg;
    banner.style.background = 'rgba(245,166,35,0.15)';
    banner.style.color = '#f5a623';
    banner.style.border = '1px solid rgba(245,166,35,0.25)';
    banner.style.opacity = '1';
    clearTimeout(banner._timer);
    banner._timer = setTimeout(() => { banner.style.opacity = '0'; }, 2500);
}
function setTradeMode(mode) {
    if (mode === 'real' && currentTradeMode !== 'real') {
        // Show confirmation modal for switching to real
        document.getElementById('realModeModal').classList.add('active');
        return;
    }
    if (mode === 'paper' && currentTradeMode === 'real') {
        showModeBanner('Switched to Paper mode — real positions are still managed');
    }
    currentTradeMode = mode;
    document.getElementById('modePaper').classList.toggle('active', mode === 'paper');
    document.getElementById('modeReal').classList.toggle('active', mode === 'real');
    document.body.setAttribute('data-trade-mode', mode);
    // Refresh everything with new mode filter
    if (_lastWsStats) applyWsStats(_lastWsStats);
    updatePositions();
    updatePortfolioStats();
    ['crypto', 'stocks', 'predictions'].forEach(fetchSegmentStatus);
}
function confirmRealMode() {
    document.getElementById('realModeModal').classList.remove('active');
    currentTradeMode = 'real';
    document.getElementById('modePaper').classList.remove('active');
    document.getElementById('modeReal').classList.add('active');
    document.body.setAttribute('data-trade-mode', 'real');
    if (_lastWsStats) applyWsStats(_lastWsStats);
    updatePositions();
    updatePortfolioStats();
    ['crypto', 'stocks', 'predictions'].forEach(fetchSegmentStatus);
}
function closeRealMode() {
    document.getElementById('realModeModal').classList.remove('active');
}
document.getElementById('realModeModal').addEventListener('click', function(e) {
    if (e.target === this) closeRealMode();
});

// ═══════════════════════════════════════
// Reinvest Slider Listeners
// ═══════════════════════════════════════
['crypto', 'stocks', 'predictions'].forEach(segment => {
    const cfg = SEGMENTS[segment];
    const slider = document.getElementById(cfg.reinvestEl);
    const label = document.getElementById(cfg.reinvestLabelEl);
    if (slider && label) {
        slider.addEventListener('input', () => {
            label.textContent = slider.value + '%';
        });
    }
});

// ═══════════════════════════════════════
// Humanize AI Decision Reasons
// ═══════════════════════════════════════
function humanizeReason(raw) {
    if (!raw) return '';

    // --- Altcoin Hunter ---
    const ahMatch = raw.match(/Altcoin Hunter:\s*score\s*([0-9.]+)/i);
    if (ahMatch) {
        const score = parseFloat(ahMatch[1]);
        const factors = [];
        if (/momentum=([0-9.]+)/.test(raw)) {
            const v = parseFloat(RegExp.$1);
            if (v >= 0.7) factors.push('strong price momentum');
            else if (v >= 0.4) factors.push('moderate momentum');
        }
        if (/rsi=([0-9.]+)/.test(raw)) {
            const v = parseFloat(RegExp.$1);
            if (v >= 0.7) factors.push('RSI in favorable zone');
        }
        if (/volume_surge=([0-9.]+)/.test(raw)) {
            const v = parseFloat(RegExp.$1);
            if (v >= 0.5) factors.push('volume surge detected');
        }
        if (/ema_alignment=([0-9.]+)/.test(raw)) {
            const v = parseFloat(RegExp.$1);
            if (v >= 0.7) factors.push('moving averages aligned bullish');
        }
        if (/adx_strength=([0-9.]+)/.test(raw)) {
            const v = parseFloat(RegExp.$1);
            if (v >= 0.5) factors.push('strong directional trend');
        }
        const strength = score >= 0.7 ? 'Very strong' : score >= 0.6 ? 'Strong' : 'Moderate';
        const detail = factors.length > 0 ? ' — ' + factors.join(', ') + '.' : '.';
        return escapeHtml(`${strength} uptrend signal (${(score*100).toFixed(0)}/100)${detail}`);
    }

    // --- Predictions AI ---
    const predMatch = raw.match(/Predictions AI:\s*(YES|NO)\s+(.+?)\s+\(AI\s+([0-9.]+)%\s+vs\s+Mkt\s+([0-9.]+)%.*?edge\s+([0-9.]+)%/i);
    if (predMatch) {
        const [, side, question, aiProb, mktProb, edge] = predMatch;
        return escapeHtml(`Betting ${side} on "${question.substring(0, 60)}" — AI sees ${edge}% edge (AI estimate: ${aiProb}% vs market: ${mktProb}%).`);
    }

    // --- Smart Auto / Ensemble ---
    if (/Smart Auto/i.test(raw) || /ensemble/i.test(raw)) {
        const signals = [];
        const buyMatch = raw.match(/BUY signal\s*\(([0-9.]+)\s*confidence\)/i);
        const sellMatch = raw.match(/SELL signal\s*\(([0-9.]+)\s*confidence\)/i);
        if (buyMatch) signals.push({dir: 'bullish', conf: parseFloat(buyMatch[1])});
        if (sellMatch) signals.push({dir: 'bearish', conf: parseFloat(sellMatch[1])});

        const parts = [];
        if (/Uptrend|EMA12\s*>\s*EMA26|above SMA/i.test(raw)) parts.push('price trending upward');
        if (/Downtrend|EMA12\s*<\s*EMA26|below SMA/i.test(raw)) parts.push('price trending downward');
        if (/overbought/i.test(raw)) parts.push('potentially overbought (may pull back)');
        if (/oversold/i.test(raw)) parts.push('potentially oversold (may bounce)');
        if (/strong trend|ADX/i.test(raw)) parts.push('strong directional movement');

        const dominant = signals.length > 0 ? signals.sort((a,b) => b.conf - a.conf)[0] : null;
        if (dominant) {
            const conf = (dominant.conf * 100).toFixed(0);
            const detail = parts.length > 0 ? ' — ' + parts.join(', ') + '.' : '.';
            return escapeHtml(`${dominant.dir === 'bullish' ? 'Bullish' : 'Bearish'} signal (${conf}% confidence)${detail}`);
        }
        if (parts.length > 0) return escapeHtml(parts.join(', ') + '.');
    }

    // --- Trend Scanner ---
    if (/Trend Scanner/i.test(raw)) {
        const parts = [];
        if (/BUY/i.test(raw)) parts.push('Buy signal detected');
        if (/SELL/i.test(raw)) parts.push('Sell signal detected');
        if (/breakout/i.test(raw)) parts.push('price breakout');
        if (/momentum/i.test(raw)) parts.push('momentum shift');
        const confM = raw.match(/([0-9.]+)\s*confidence/);
        if (confM) parts.push(`${(parseFloat(confM[1])*100).toFixed(0)}% confidence`);
        return escapeHtml(parts.join(' — ') || raw.substring(0, 120));
    }

    // --- Continuous re-entry ---
    if (/Continuous re-entry/i.test(raw)) {
        return escapeHtml('Autopilot re-entering position based on ongoing signal.');
    }

    // --- AI Exit ---
    if (/ai.*exit|stale.*position|trailing.*stop/i.test(raw)) {
        return escapeHtml(raw.replace(/\|/g, ' — ').substring(0, 150));
    }

    // --- Fallback: clean up raw text ---
    let text = raw;
    text = text.replace(/\[[\w_]+\]\s*/g, '');
    text = text.replace(/\s*\|\s*/g, ' — ');
    text = text.replace(/\s*;\s*/g, '. ');
    text = text.replace(/([A-Z_]+)\(([0-9.]+)\)/g, (_, sig, val) => {
        const v = parseFloat(val);
        return `${sig.toLowerCase()} (${(v*100).toFixed(0)}%)`;
    });
    return escapeHtml(text.substring(0, 200));
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// (Portfolio chart is now at the top — see renderTopPortfolioChart)

// ═══════════════════════════════════════
// Tab Navigation
// ═══════════════════════════════════════
let pmLoaded = false;
let pmTimeframe = 14;
let pmSource = 'polymarket';

function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    // Update nav active states
    document.getElementById('navDashboard').classList.toggle('active', tab === 'trading');
    document.getElementById('navMarkets').classList.toggle('active', tab === 'markets');
    // Trade mode toggle is now in the nav bar — always visible

    if (tab === 'trading') {
        document.getElementById('contentTrading').classList.add('active');
    } else if (tab === 'markets') {
        document.getElementById('contentMarkets').classList.add('active');
        // Load crypto by default on first visit
        if (!_marketsLoaded.crypto) {
            loadMarketsCrypto();
            _marketsLoaded.crypto = true;
        }
    }
}

// ═══════════════════════════════════════
// Markets Sub-tab Navigation
// ═══════════════════════════════════════
const _marketsLoaded = { crypto: false, stocks: false, predictions: false };
let _marketsSortCol = 'market_cap';
let _marketsSortDir = -1;

function switchMarketTab(sub) {
    document.querySelectorAll('.market-sub-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.market-sub-content').forEach(c => c.classList.remove('active'));
    document.getElementById('mktTab' + sub.charAt(0).toUpperCase() + sub.slice(1)).classList.add('active');
    document.getElementById('mktContent' + sub.charAt(0).toUpperCase() + sub.slice(1)).classList.add('active');

    // Show/hide search bar (not relevant for predictions)
    document.getElementById('mktSearchWrap').style.display = sub === 'predictions' ? 'none' : 'block';

    // Lazy-load data
    if (sub === 'crypto' && !_marketsLoaded.crypto) {
        loadMarketsCrypto();
        _marketsLoaded.crypto = true;
    } else if (sub === 'stocks' && !_marketsLoaded.stocks) {
        loadMarketsStocks();
        _marketsLoaded.stocks = true;
    } else if (sub === 'predictions' && !_marketsLoaded.predictions) {
        if (!pmLoaded) {
            fetchPolymarkets();
            pmLoaded = true;
        }
        _marketsLoaded.predictions = true;
    }
}

// ═══════════════════════════════════════
// Markets — Crypto Table
// ═══════════════════════════════════════
let _cryptoMarkets = [];

async function loadMarketsCrypto() {
    const container = document.getElementById('mktCryptoTable');
    try {
        const resp = await fetch('/api/markets/crypto');
        if (!resp.ok) throw new Error('Failed');
        const data = await resp.json();
        _cryptoMarkets = data.markets || [];
        renderCryptoTable();
    } catch(e) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Failed to load crypto markets. Check exchange connection.</div>';
    }
}

function renderCryptoTable() {
    const container = document.getElementById('mktCryptoTable');
    const search = (document.getElementById('mktSearchInput').value || '').toLowerCase();
    let items = _cryptoMarkets.filter(m => !search || m.symbol.toLowerCase().includes(search) || (m.name || '').toLowerCase().includes(search));

    // Sort
    items.sort((a, b) => {
        const av = a[_marketsSortCol] || 0, bv = b[_marketsSortCol] || 0;
        return (av - bv) * _marketsSortDir;
    });

    if (items.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No markets found</div>';
        return;
    }

    let html = `<table class="mkt-table">
        <thead><tr>
            <th onclick="sortMarkets('name')">Asset</th>
            <th onclick="sortMarkets('price')" style="text-align:right;">Price</th>
            <th onclick="sortMarkets('change_pct')" style="text-align:right;">24h</th>
            <th onclick="sortMarkets('volume')" style="text-align:right;">Volume</th>
            <th onclick="sortMarkets('market_cap')" style="text-align:right;">Mkt Cap</th>
        </tr></thead><tbody>`;

    for (const m of items) {
        const sym = m.symbol.split('/')[0];
        const price = m.price > 1 ? '$' + m.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                  : '$' + m.price.toFixed(6);
        const chg = m.change_pct || 0;
        const chgClass = chg >= 0 ? 'up' : 'down';
        const chgStr = (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%';
        const vol = m.volume ? '$' + _formatCompact(m.volume) : '—';
        const mcap = m.market_cap ? '$' + _formatCompact(m.market_cap) : '—';

        html += `<tr>
            <td><div class="mkt-symbol">${sym}<span class="mkt-symbol-sub">${m.name || ''}</span></div></td>
            <td style="text-align:right;font-weight:600;">${price}</td>
            <td style="text-align:right;"><span class="mkt-change ${chgClass}">${chgStr}</span></td>
            <td style="text-align:right;color:var(--text-secondary);">${vol}</td>
            <td style="text-align:right;color:var(--text-secondary);">${mcap}</td>
        </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
}

function _formatCompact(n) {
    if (n >= 1e12) return (n / 1e12).toFixed(1) + 'T';
    if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n.toFixed(0);
}

function sortMarkets(col) {
    if (_marketsSortCol === col) {
        _marketsSortDir *= -1;
    } else {
        _marketsSortCol = col;
        _marketsSortDir = col === 'name' ? 1 : -1;
    }
    // Re-render whichever sub-tab is active
    if (document.getElementById('mktContentCrypto').classList.contains('active')) renderCryptoTable();
    else if (document.getElementById('mktContentStocks').classList.contains('active')) renderStocksTable();
}

function filterMarketTable() {
    if (document.getElementById('mktContentCrypto').classList.contains('active')) renderCryptoTable();
    else if (document.getElementById('mktContentStocks').classList.contains('active')) renderStocksTable();
}

// ═══════════════════════════════════════
// Markets — Stocks Table
// ═══════════════════════════════════════
let _stockMarkets = [];

async function loadMarketsStocks() {
    const container = document.getElementById('mktStocksTable');
    try {
        const resp = await fetch('/api/markets/stocks');
        if (!resp.ok) throw new Error('Failed');
        const data = await resp.json();
        _stockMarkets = data.markets || [];
        renderStocksTable();
    } catch(e) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Failed to load stock markets. Check Alpaca connection.</div>';
    }
}

function renderStocksTable() {
    const container = document.getElementById('mktStocksTable');
    const search = (document.getElementById('mktSearchInput').value || '').toLowerCase();
    let items = _stockMarkets.filter(m => !search || m.symbol.toLowerCase().includes(search) || (m.name || '').toLowerCase().includes(search));

    items.sort((a, b) => {
        const av = a[_marketsSortCol] || 0, bv = b[_marketsSortCol] || 0;
        if (typeof av === 'string') return av.localeCompare(bv) * _marketsSortDir;
        return (av - bv) * _marketsSortDir;
    });

    if (items.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No stock markets found</div>';
        return;
    }

    let html = `<table class="mkt-table">
        <thead><tr>
            <th onclick="sortMarkets('name')">Asset</th>
            <th onclick="sortMarkets('price')" style="text-align:right;">Price</th>
            <th onclick="sortMarkets('change_pct')" style="text-align:right;">24h</th>
            <th onclick="sortMarkets('volume')" style="text-align:right;">Volume</th>
            <th onclick="sortMarkets('market_cap')" style="text-align:right;">Mkt Cap</th>
        </tr></thead><tbody>`;

    for (const m of items) {
        const sym = m.symbol.split('/')[0];
        const price = '$' + (m.price || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const chg = m.change_pct || 0;
        const chgClass = chg >= 0 ? 'up' : 'down';
        const chgStr = (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%';
        const vol = m.volume ? '$' + _formatCompact(m.volume) : '—';
        const mcap = m.market_cap ? '$' + _formatCompact(m.market_cap) : '—';

        html += `<tr>
            <td><div class="mkt-symbol">${sym}<span class="mkt-symbol-sub">${m.name || ''}</span></div></td>
            <td style="text-align:right;font-weight:600;">${price}</td>
            <td style="text-align:right;"><span class="mkt-change ${chgClass}">${chgStr}</span></td>
            <td style="text-align:right;color:var(--text-secondary);">${vol}</td>
            <td style="text-align:right;color:var(--text-secondary);">${mcap}</td>
        </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
}

// ═══════════════════════════════════════
// Polymarket — Prediction Markets
// ═══════════════════════════════════════
let pmAllMarkets = [];

function setPmSource(src) {
    pmSource = src;
    document.getElementById('pmSrcPoly').classList.toggle('active', src === 'polymarket');
    document.getElementById('pmSrcKalshi').classList.toggle('active', src === 'kalshi');
    document.getElementById('pmSourceTitle').textContent = src === 'kalshi' ? 'Kalshi' : 'Polymarket';
    // Kalshi has mostly long-term markets, default to All timeframe
    if (src === 'kalshi' && pmTimeframe < 30) {
        setPmTimeframe(0);
        return;
    }
    pmLoaded = false;
    fetchPolymarkets();
}

function setPmTimeframe(days) {
    pmTimeframe = days;
    // Update active state for timeframe pills only
    ['pmTf3','pmTf7','pmTf14','pmTf30','pmTf0'].forEach(id => {
        document.getElementById(id).classList.remove('active');
    });
    document.getElementById('pmTf' + days).classList.add('active');
    pmLoaded = false;
    fetchPolymarkets();
}

function toggleMethodology() {
    const el = document.getElementById('pmMethodologyDetail');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function toggleSignals(id) {
    const el = document.getElementById('signals-' + id);
    if (el) el.classList.toggle('open');
}

async function fetchPolymarkets() {
    const container = document.getElementById('pmMarketsContainer');
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Loading markets...</div>';
    try {
        const apiUrl = pmSource === 'kalshi'
            ? `/api/kalshi/markets?limit=30&max_days=${pmTimeframe}`
            : `/api/polymarket/markets?limit=30&max_days=${pmTimeframe}`;
        const resp = await fetch(apiUrl);
        const data = await resp.json();
        if (data.error) {
            container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red);">${escapeHtml(data.error)}</div>`;
            return;
        }
        pmAllMarkets = data.markets || [];
        pmLoaded = true;
        renderPolymarkets(pmAllMarkets);
    } catch(e) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red);">Failed to load markets</div>';
    }
}

function filterPolymarkets() {
    const cat = document.getElementById('pmCategoryFilter').value;
    if (cat === 'all') {
        renderPolymarkets(pmAllMarkets);
    } else {
        const filtered = pmAllMarkets.filter(m => (m.tags || []).some(t => t.toLowerCase().includes(cat.toLowerCase())));
        renderPolymarkets(filtered);
    }
}

function fmtVol(v) {
    if (v >= 1e6) return `$${(v / 1e6).toFixed(1)}M`;
    if (v >= 1e3) return `$${(v / 1e3).toFixed(0)}K`;
    return `$${v.toFixed(0)}`;
}

function renderPolymarkets(markets) {
    const container = document.getElementById('pmMarketsContainer');
    if (!markets.length) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No markets found for this timeframe/category. Try a longer timeframe.</div>';
        return;
    }

    let html = '<div style="display:grid;gap:12px;">';
    for (const m of markets) {
        const question = escapeHtml(m.question || '');
        const vol = fmtVol(m.volume);
        const vol24 = fmtVol(m.volume_24h);
        const liq = fmtVol(m.liquidity);

        const edge = m.ai_edge || {};
        const hasEdge = edge.ev_per_dollar > 0;
        const edgeSide = edge.side || '';
        const edgePct = (edge.edge_pct || 0).toFixed(1);
        const gain100 = m.potential_gain_100 || 0;
        const aiProb = m.ai_probability || 0;
        const mktProb = m.market_probability || 0;
        const confidence = m.ai_confidence || 'low';

        // Tags
        let tagsHtml = (m.tags || []).map(t => `<span class="pm-tag">${escapeHtml(t)}</span>`).join(' ');

        // Outcomes — market price vs AI
        let outcomesHtml = '';
        const outcomes = m.outcomes || [];
        const yesOutcome = outcomes.find(o => o.name === 'Yes') || outcomes[0];
        const noOutcome = outcomes.find(o => o.name === 'No') || outcomes[1];

        if (yesOutcome && noOutcome) {
            const yesPct = yesOutcome.probability;
            const noPct = noOutcome.probability;
            outcomesHtml = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:13px;color:var(--text-secondary);">Yes</span>
                        <span style="font-size:20px;font-weight:700;color:var(--text);">${yesPct.toFixed(0)}%</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:20px;font-weight:700;color:var(--text);">${noPct.toFixed(0)}%</span>
                        <span style="font-size:13px;color:var(--text-secondary);">No</span>
                    </div>
                </div>
                <div class="pm-prob-bar">
                    <div class="pm-prob-fill" style="width:${yesPct}%;"></div>
                </div>
            `;
        } else {
            for (const o of outcomes) {
                const pct = o.probability;
                const color = pct >= 50 ? 'var(--green)' : pct >= 20 ? 'var(--text)' : 'var(--text-muted)';
                outcomesHtml += `
                    <div class="pm-outcome">
                        <span class="pm-outcome-name">${escapeHtml(o.name)}</span>
                        <span class="pm-outcome-price" style="color:${color};">${pct.toFixed(0)}%</span>
                    </div>
                `;
            }
        }

        // AI Edge row (auto-invested by Predictions autopilot when enabled)
        let aiRowHtml = '';
        if (hasEdge) {
            const confDot = `<span class="pm-confidence ${confidence}"></span>`;
            const signalsList = (m.ai_signals || []).map(s => `<div class="pm-signal-item">${escapeHtml(s)}</div>`).join('');
            aiRowHtml = `
                <div class="pm-ai-row">
                    <div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:2px;">AI says</div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:16px;font-weight:700;">${aiProb.toFixed(0)}%</span>
                            <span style="font-size:11px;color:var(--text-muted);">vs market ${mktProb.toFixed(0)}%</span>
                            <span class="pm-edge-badge ${hasEdge ? 'positive' : 'neutral'}">
                                ${confDot}${edgeSide} +${edgePct}%
                            </span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:2px;">$100 potential</div>
                        <span class="pm-gain-chip">+$${gain100.toFixed(2)}</span>
                    </div>
                </div>
                ${signalsList ? `
                    <button class="pm-signals-toggle" onclick="toggleSignals('${m.id}')" style="margin-top:6px;">View trading signals</button>
                    <div class="pm-signals-list" id="signals-${m.id}">${signalsList}</div>
                ` : ''}
            `;
        } else {
            aiRowHtml = `
                <div class="pm-ai-row" style="opacity:0.5;">
                    <div>
                        <div style="font-size:11px;color:var(--text-muted);">No significant edge detected</div>
                    </div>
                </div>
            `;
        }

        // End date
        let endHtml = '';
        const daysLeft = m.days_left || 0;
        if (m.end_date) {
            const end = new Date(m.end_date);
            const endStr = end.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
            const urgency = daysLeft <= 3 ? 'color:var(--red);font-weight:600;' : daysLeft <= 7 ? 'color:#f5a623;' : 'color:var(--text-muted);';
            const daysLabel = daysLeft < 1 ? '<1d' : `${Math.ceil(daysLeft)}d`;
            endHtml = `<span style="font-size:11px;${urgency}">${daysLabel} left &middot; ${endStr}</span>`;
        }

        // Market link
        const slug = m.slug || '';
        const marketUrl = pmSource === 'kalshi'
            ? (slug ? `https://kalshi.com/markets/${slug}` : `https://kalshi.com`)
            : (slug ? `https://polymarket.com/event/${slug}` : `https://polymarket.com`);
        const linkLabel = pmSource === 'kalshi' ? 'View on Kalshi' : 'View on Polymarket';

        html += `
        <div class="pm-card${hasEdge ? ' has-edge' : ''}">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
                <div style="flex:1;">
                    <div style="font-size:15px;font-weight:600;line-height:1.3;margin-bottom:6px;">${question}</div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        ${tagsHtml}
                        <span class="pm-volume">Vol: ${vol}</span>
                        <span class="pm-volume">24h: ${vol24}</span>
                        <span class="pm-volume">Liq: ${liq}</span>
                        ${endHtml}
                        <a href="${marketUrl}" target="_blank" rel="noopener" style="font-size:11px;color:var(--accent);font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:3px;">${linkLabel} &#x2197;</a>
                    </div>
                </div>
            </div>
            ${outcomesHtml}
            ${aiRowHtml}
        </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;
}

// Handle ?tab=markets query parameter (for nav links from other pages)
(function() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('tab') === 'markets') {
        switchTab('markets');
    }
})();
</script>
{% endblock %}
