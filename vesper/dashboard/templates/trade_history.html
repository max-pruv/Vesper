{% extends "base.html" %}
{% block title %}Trade History — Vesper{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}
{% block body %}

<div class="nav">
    <span class="nav-logo">vesper</span>
    <div class="nav-links">
        <a class="nav-link" href="/dashboard">Dashboard</a>
        <a class="nav-link" href="/dashboard?tab=markets">Markets</a>
        <a class="nav-link" href="/how-it-works">How it works</a>
        <a class="nav-link active" href="/trade-history">Trade History</a>
        <a class="nav-link" href="/settings">Settings</a>
        {% if user.is_admin %}<a class="nav-link" href="/admin">Admin</a>{% endif %}
        <div class="nav-trade-mode" id="tradeModeToggle">
            <button class="trade-mode-btn {{ '' if user.trading_mode == 'live' else 'active' }}" id="modePaper" onclick="setTradeMode('paper')" data-mode="paper">
                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#f5a623;margin-right:4px;"></span>Paper
            </button>
            <button class="trade-mode-btn {{ 'active' if user.trading_mode == 'live' else '' }}" id="modeReal" onclick="setTradeMode('real')" data-mode="real">
                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:4px;"></span>Real
            </button>
        </div>
        <a class="nav-link nav-logout" href="/logout" title="Log out">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </a>
    </div>
</div>

<div class="page-wrapper" style="padding-top:32px;padding-bottom:64px;">

    <!-- KPI Cards -->
    <div id="kpiGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px;">
        <div class="stat-glass slide-up" id="kpi-invested">
            <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Initial Investment</div>
            <div style="font-size:28px;font-weight:800;margin-top:4px;color:var(--text);" id="kpi-invested-value">
                ${{ "%.2f"|format(initial_balance) }}
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;" id="kpi-invested-detail">
                Total P&L: <span id="kpi-total-pnl">—</span>
            </div>
        </div>
        <div class="stat-glass slide-up" style="animation-delay:0.05s;" id="kpi-overall">
            <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Overall Win Rate</div>
            <div style="font-size:28px;font-weight:800;margin-top:4px;" id="kpi-overall-rate"
                 class="{{ 'positive' if kpis.overall.rate >= 50 else 'negative' }}">
                {{ kpis.overall.rate }}%
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;" id="kpi-overall-detail">
                {{ kpis.overall.wins }}/{{ kpis.overall.total }} trades
            </div>
        </div>
        <div class="stat-glass slide-up" style="animation-delay:0.1s;" id="kpi-crypto">
            <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Crypto Win Rate</div>
            <div style="font-size:28px;font-weight:800;margin-top:4px;" id="kpi-crypto-rate"
                 class="{{ 'positive' if kpis.crypto.rate >= 50 else 'negative' }}">
                {{ kpis.crypto.rate }}%
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;" id="kpi-crypto-detail">
                {{ kpis.crypto.wins }}/{{ kpis.crypto.total }} trades
            </div>
        </div>
        <div class="stat-glass slide-up" style="animation-delay:0.15s;" id="kpi-stocks">
            <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Stocks Win Rate</div>
            <div style="font-size:28px;font-weight:800;margin-top:4px;" id="kpi-stocks-rate"
                 class="{{ 'positive' if kpis.stocks.rate >= 50 else 'negative' }}">
                {{ kpis.stocks.rate }}%
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;" id="kpi-stocks-detail">
                {{ kpis.stocks.wins }}/{{ kpis.stocks.total }} trades
            </div>
        </div>
        <div class="stat-glass slide-up" style="animation-delay:0.2s;" id="kpi-predictions">
            <div style="font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Predictions Win Rate</div>
            <div style="font-size:28px;font-weight:800;margin-top:4px;" id="kpi-predictions-rate"
                 class="{{ 'positive' if kpis.predictions.rate >= 50 else 'negative' }}">
                {{ kpis.predictions.rate }}%
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;" id="kpi-predictions-detail">
                {{ kpis.predictions.wins }}/{{ kpis.predictions.total }} trades
            </div>
        </div>
    </div>

    <!-- Win Rate Chart -->
    <div class="card slide-up" style="animation-delay:0.2s;padding:24px;margin-bottom:24px;">
        <div class="card-title">Win Rate Over Time</div>
        <div style="position:relative;height:280px;">
            <canvas id="winRateChart"></canvas>
        </div>
    </div>

    <!-- Filters -->
    <div class="card slide-up" style="animation-delay:0.25s;padding:16px 24px;margin-bottom:24px;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
            <div style="display:flex;gap:4px;" id="typeFilters">
                <button class="tab-pill active" data-type="all" onclick="setTypeFilter('all')">All</button>
                <button class="tab-pill" data-type="crypto" onclick="setTypeFilter('crypto')">Crypto</button>
                <button class="tab-pill" data-type="stocks" onclick="setTypeFilter('stocks')">Stocks</button>
                <button class="tab-pill" data-type="predictions" onclick="setTypeFilter('predictions')">Predictions</button>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">From</label>
                <input type="date" class="input" id="dateFrom" style="width:150px;padding:8px 12px;font-size:13px;" onchange="applyFilters()">
                <label style="font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">To</label>
                <input type="date" class="input" id="dateTo" style="width:150px;padding:8px 12px;font-size:13px;" onchange="applyFilters()">
            </div>
        </div>
    </div>

    <!-- Trade History Table -->
    <div class="card slide-up" style="animation-delay:0.3s;padding:0;overflow:hidden;">
        <div style="overflow-x:auto;">
            <table id="tradeTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Result</th>
                        <th>Side</th>
                        <th style="text-align:right;">Entry Amt</th>
                        <th>Entry Price</th>
                        <th>Exit Price</th>
                        <th style="text-align:right;">Gross P&L</th>
                        <th style="text-align:right;">Net P&L</th>
                        <th style="text-align:right;">Net %</th>
                        <th>Duration</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="tradeTableBody">
                </tbody>
            </table>
        </div>
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-state-icon">~</div>
            <p>No trades match your filters.</p>
        </div>
    </div>

</div>

<style>
    @media (max-width: 1024px) {
        #kpiGrid {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }
    @media (max-width: 768px) {
        #kpiGrid {
            grid-template-columns: repeat(2, 1fr) !important;
        }
        #typeFilters {
            flex-wrap: wrap;
        }
        div[style*="display:flex;align-items:center;gap:8px"] {
            flex-wrap: wrap;
        }
    }
    .type-badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        text-transform: capitalize;
    }
    .type-badge-crypto {
        background: rgba(0,232,94,0.1);
        color: var(--green);
    }
    .type-badge-stocks {
        background: rgba(99,102,241,0.1);
        color: #818cf8;
    }
    .type-badge-predictions {
        background: rgba(168,85,247,0.1);
        color: #a855f7;
    }
    .side-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .side-buy {
        background: rgba(0,232,94,0.08);
        color: var(--green);
    }
    .side-sell {
        background: rgba(255,68,68,0.08);
        color: var(--red);
    }
    .result-badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .result-win {
        background: rgba(0,232,94,0.12);
        color: var(--green);
    }
    .result-loss {
        background: rgba(255,68,68,0.12);
        color: var(--red);
    }
    .result-even {
        background: rgba(255,255,255,0.06);
        color: var(--text-muted);
    }
    .reason-cell {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
        color: var(--text-secondary);
    }
    .reason-cell:hover {
        white-space: normal;
        overflow: visible;
    }
</style>

<script>
(function() {
    const allTrades = {{ trades|tojson }};
    const chartData = {{ chart_data|tojson }};
    const initialBalance = {{ initial_balance }};
    let currentType = 'all';
    let currentTradeMode = '{{ "real" if user.trading_mode == "live" else "paper" }}';
    let winRateChart = null;

    // --- Trade mode toggle ---
    window.setTradeMode = function(mode) {
        currentTradeMode = mode;
        document.getElementById('modePaper').classList.toggle('active', mode === 'paper');
        document.getElementById('modeReal').classList.toggle('active', mode === 'real');
        applyFilters();
    };

    // Format Unix timestamp to user's local timezone
    function fmtDate(ts) {
        if (!ts) return '—';
        return new Date(ts * 1000).toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
    }
    function fmtDateTime(ts) {
        if (!ts) return '—';
        return new Date(ts * 1000).toLocaleString(undefined, { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }
    // Convert Unix timestamp to YYYY-MM-DD in local timezone (for date filter comparison)
    function tsToLocalDate(ts) {
        if (!ts) return '';
        const d = new Date(ts * 1000);
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }

    // Format chart x-axis labels from raw timestamps
    function fmtChartLabel(ts) {
        if (!ts) return '';
        return new Date(ts * 1000).toLocaleDateString(undefined, { month:'short', day:'numeric' });
    }

    // Convert chart data x values from raw timestamps to formatted labels
    function convertChartData(series) {
        if (!series) return [];
        return series.map(p => ({ x: fmtChartLabel(p.x), y: p.y }));
    }

    // --- Render chart ---
    function renderWinRateChart() {
        const ctx = document.getElementById('winRateChart').getContext('2d');

        const datasets = [];
        const cOverall = convertChartData(chartData.overall);
        const cCrypto = convertChartData(chartData.crypto);
        const cStocks = convertChartData(chartData.stocks);
        const cPredictions = convertChartData(chartData.predictions);

        if (cOverall.length > 0) {
            datasets.push({
                label: 'Overall',
                data: cOverall,
                borderColor: '#f0f0f5',
                backgroundColor: 'rgba(240,240,245,0.05)',
                borderWidth: 2,
                pointRadius: 0,
                pointHitRadius: 8,
                tension: 0.3,
                fill: true,
            });
        }
        if (cCrypto.length > 0) {
            datasets.push({
                label: 'Crypto',
                data: cCrypto,
                borderColor: '#00e85e',
                backgroundColor: 'rgba(0,232,94,0.04)',
                borderWidth: 1.5,
                pointRadius: 0,
                pointHitRadius: 8,
                tension: 0.3,
                fill: false,
            });
        }
        if (cStocks.length > 0) {
            datasets.push({
                label: 'Stocks',
                data: cStocks,
                borderColor: '#818cf8',
                backgroundColor: 'rgba(99,102,241,0.04)',
                borderWidth: 1.5,
                pointRadius: 0,
                pointHitRadius: 8,
                tension: 0.3,
                fill: false,
            });
        }
        if (cPredictions.length > 0) {
            datasets.push({
                label: 'Predictions',
                data: cPredictions,
                borderColor: '#a855f7',
                backgroundColor: 'rgba(168,85,247,0.04)',
                borderWidth: 1.5,
                pointRadius: 0,
                pointHitRadius: 8,
                tension: 0.3,
                fill: false,
            });
        }

        if (datasets.length === 0) {
            document.getElementById('winRateChart').parentElement.innerHTML =
                '<div class="empty-state"><div class="empty-state-icon">~</div><p>No trade data for chart yet.</p></div>';
            return;
        }

        // 50% reference line
        datasets.push({
            label: '50% Line',
            data: datasets[0].data.map(p => ({ x: p.x, y: 50 })),
            borderColor: 'rgba(255,255,255,0.15)',
            borderWidth: 1,
            borderDash: [6, 4],
            pointRadius: 0,
            pointHitRadius: 0,
            fill: false,
            tension: 0,
        });

        winRateChart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#9ca3af',
                            font: { size: 11, family: 'Inter' },
                            boxWidth: 12,
                            boxHeight: 2,
                            padding: 16,
                            filter: function(item) {
                                return item.text !== '50% Line';
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(10,10,14,0.95)',
                        borderColor: 'rgba(255,255,255,0.08)',
                        borderWidth: 1,
                        titleColor: '#f0f0f5',
                        bodyColor: '#9ca3af',
                        titleFont: { size: 12, weight: 600 },
                        bodyFont: { size: 11 },
                        padding: 10,
                        cornerRadius: 8,
                        filter: function(item) {
                            return item.dataset.label !== '50% Line';
                        },
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        labels: cOverall.map(p => p.x),
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: {
                            color: '#6b7280',
                            font: { size: 10 },
                            maxTicksLimit: 12,
                            maxRotation: 0,
                        },
                        border: { display: false },
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: {
                            color: '#6b7280',
                            font: { size: 10 },
                            callback: function(v) { return v + '%'; },
                            stepSize: 25,
                        },
                        border: { display: false },
                    }
                }
            }
        });
    }

    // --- Render table ---
    function renderTable(trades) {
        const tbody = document.getElementById('tradeTableBody');
        const empty = document.getElementById('emptyState');

        if (trades.length === 0) {
            tbody.innerHTML = '';
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';

        tbody.innerHTML = trades.map(t => {
            const grossClass = t.pnl_usd >= 0 ? 'positive' : 'negative';
            const grossSign = t.pnl_usd >= 0 ? '+' : '';
            // Use pnl_usd (gross) as primary indicator since net_pnl_usd can be 0 for old trades
            const effectiveNet = (t.net_pnl_usd && t.net_pnl_usd !== 0) ? t.net_pnl_usd : t.pnl_usd;
            const effectiveNetPct = (t.net_pnl_pct && t.net_pnl_pct !== 0) ? t.net_pnl_pct : t.pnl_pct;
            const netClass = effectiveNet >= 0 ? 'positive' : 'negative';
            const netSign = effectiveNet >= 0 ? '+' : '';
            // Result badge: WIN / LOSS / EVEN
            const isWin = t.pnl_usd > 0;
            const isLoss = t.pnl_usd < 0;
            const resultBadge = isWin ? '<span class="result-badge result-win">WIN</span>'
                : isLoss ? '<span class="result-badge result-loss">LOSS</span>'
                : '<span class="result-badge result-even">EVEN</span>';
            return `<tr data-type="${t.type}" data-exit-ts="${t.exit_date}">
                <td style="font-size:13px;font-family:monospace;color:var(--text-secondary);white-space:nowrap;">${fmtDateTime(t.exit_date)}</td>
                <td style="font-weight:600;">${t.symbol}</td>
                <td><span class="type-badge type-badge-${t.type}">${t.type}</span></td>
                <td>${resultBadge}</td>
                <td><span class="side-badge side-${t.side}">${t.side}</span></td>
                <td style="text-align:right;font-family:monospace;font-size:13px;">$${Number(t.cost_usd || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td style="font-family:monospace;font-size:13px;">$${Number(t.entry_price).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:6})}</td>
                <td style="font-family:monospace;font-size:13px;">$${Number(t.exit_price).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:6})}</td>
                <td style="text-align:right;font-size:12px;" class="${grossClass}">${grossSign}$${t.pnl_usd.toFixed(2)}</td>
                <td style="text-align:right;font-weight:700;" class="${netClass}">${netSign}$${effectiveNet.toFixed(2)}</td>
                <td style="text-align:right;font-weight:600;" class="${netClass}">${netSign}${effectiveNetPct.toFixed(2)}%</td>
                <td style="font-size:13px;color:var(--text-muted);">${t.duration}</td>
                <td class="reason-cell" title="${(t.reason || '').replace(/"/g, '&quot;')}">${t.reason || '—'}</td>
            </tr>`;
        }).join('');
    }

    // --- Update KPI cards ---
    function updateKPIs(trades) {
        function calc(list) {
            const total = list.length;
            // Use gross pnl_usd for win/loss — always reliably set
            const wins = list.filter(t => t.pnl_usd > 0).length;
            const rate = total > 0 ? Math.round(wins / total * 1000) / 10 : 0;
            return { total, wins, rate };
        }

        const overall = calc(trades);
        const crypto = calc(trades.filter(t => t.type === 'crypto'));
        const stocks = calc(trades.filter(t => t.type === 'stocks'));
        const predictions = calc(trades.filter(t => t.type === 'predictions'));

        // Total P&L across filtered trades
        const totalPnl = trades.reduce((sum, t) => {
            const net = (t.net_pnl_usd && t.net_pnl_usd !== 0) ? t.net_pnl_usd : t.pnl_usd;
            return sum + net;
        }, 0);
        const pnlEl = document.getElementById('kpi-total-pnl');
        if (pnlEl) {
            const sign = totalPnl >= 0 ? '+' : '';
            pnlEl.textContent = sign + '$' + totalPnl.toFixed(2);
            pnlEl.className = totalPnl >= 0 ? 'positive' : 'negative';
        }

        function setKPI(id, data) {
            const rateEl = document.getElementById(id + '-rate');
            const detailEl = document.getElementById(id + '-detail');
            if (rateEl) {
                rateEl.textContent = data.rate + '%';
                rateEl.className = data.rate >= 50 ? 'positive' : (data.total === 0 ? '' : 'negative');
            }
            if (detailEl) {
                detailEl.textContent = data.wins + '/' + data.total + ' trades';
            }
        }

        setKPI('kpi-overall', overall);
        setKPI('kpi-crypto', crypto);
        setKPI('kpi-stocks', stocks);
        setKPI('kpi-predictions', predictions);
    }

    // --- Filtering ---
    function getFilteredTrades() {
        // First filter by trade mode
        let filtered = allTrades.filter(t => (t.trade_mode || 'paper') === currentTradeMode);

        if (currentType !== 'all') {
            filtered = filtered.filter(t => t.type === currentType);
        }

        const fromVal = document.getElementById('dateFrom').value;  // YYYY-MM-DD
        const toVal = document.getElementById('dateTo').value;

        if (fromVal) {
            filtered = filtered.filter(t => tsToLocalDate(t.exit_date) >= fromVal);
        }
        if (toVal) {
            filtered = filtered.filter(t => tsToLocalDate(t.exit_date) <= toVal);
        }

        return filtered;
    }

    window.setTypeFilter = function(type) {
        currentType = type;
        document.querySelectorAll('#typeFilters .tab-pill').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-type') === type);
        });
        applyFilters();
    };

    window.applyFilters = function() {
        const filtered = getFilteredTrades();
        renderTable(filtered);
        updateKPIs(filtered);
    };

    // --- Init ---
    renderWinRateChart();
    // Apply initial filter (trade mode + type)
    applyFilters();
})();
</script>

{% endblock %}
